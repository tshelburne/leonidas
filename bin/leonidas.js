(function(){var b=window.modules||[],a=null;b.leonidas__client=function(){if(null===a){var l=function(a,k){this.id=a;this.lockedState=k;this.activeState={};this.copyState(this.activeState,this.lockedState)};l.prototype.revertState=function(){return this.copyState(this.activeState,this.lockedState)};l.prototype.lockState=function(){return this.copyState(this.lockedState,this.activeState)};l.prototype.copyState=function(a,k){var e,f,c;for(e in a)delete a[e];c=[];for(e in k)f=k[e],c.push(a[e]=f);return c};
a=l}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commander=function(){if(null===a){var l,g,k,e,f;l=require("leonidas/commands/command");g=require("leonidas/commands/organizer");k=require("leonidas/commands/processor");e=require("leonidas/commands/stabilizer");f=require("leonidas/commands/synchronizer");var c=function(e,c,f,a,k){this.client=e;this.organizer=c;this.processor=f;this.stabilizer=a;this.synchronizer=k};c.create=function(c,a,l){var b,t;b=new g;a=new k(a);t=new e(c,b,a);l=new f(l,
c,b,t);return new this(c,b,a,t,l)};c.prototype.startSync=function(e,c){null==e&&(e=1E3);null==c&&(c=5E3);this.pushInterval=setInterval(this.synchronizer.push,e);return this.pullInterval=setInterval(this.synchronizer.pull,c)};c.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};c.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};c.prototype.issueCommand=function(e,c){var f;f=new l(e,c,this.client.id);this.organizer.addCommand(f);
return this.processor.processCommand(f)};a=c}return a};window.modules=b})();(function(){var b=window.modules||[],a=null;b.leonidas__commands__command=function(){if(null===a){var b=function(a,k,e,f){this.name=a;this.data=k;this.clientId=e;null==f&&(f=null);this.timestamp=null!=f?f:new Date};b.prototype.toHash=function(){return{name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__handler=function(){if(null===a){var b=function(){};b.prototype.handles=function(a){return a.name===this.name};b.prototype.run=function(){throw Error("Every CommandHandler should override to process a command #run.");};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__organizer=function(){if(null===a){var b=[].indexOf||function(a){for(var e=0,f=this.length;e<f;e++)if(e in this&&this[e]===a)return e;return-1},g=function(){this.unsyncedCommands=[];this.syncedCommands=[];this.lockedCommands=[]};g.prototype.addCommand=function(a,e){null==e&&(e=!0);return e?this.unsyncedCommands.push(a):this.syncedCommands.push(a)};g.prototype.addCommands=function(a,e){var f,c,b,g;null==e&&(e=!0);g=[];c=0;for(b=a.length;c<
b;c++)f=a[c],g.push(this.addCommand(f,e));return g};g.prototype.markAsSynced=function(a){var e,f,c;f=0;for(c=a.length;f<c;f++)e=a[f],0>b.call(this.syncedCommands,e)&&this.syncedCommands.push(e);var h,g;h=this.unsyncedCommands;g=[];f=0;for(c=h.length;f<c;f++)e=h[f],0>b.call(a,e)&&g.push(e);return this.unsyncedCommands=g};g.prototype.lockCommands=function(a){var e,f,c;f=0;for(c=a.length;f<c;f++)e=a[f],this.lockedCommands.push(e);var g,B;g=this.syncedCommands;B=[];f=0;for(c=g.length;f<c;f++)e=g[f],0>
b.call(a,e)&&B.push(e);return this.syncedCommands=B};g.prototype.activeCommands=function(){return this.unsyncedCommands.concat(this.syncedCommands).sort(function(a,e){return a.timestamp>e.timestamp?1:-1})};a=g}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__processor=function(){if(null===a){var b=function(a){this.handlers=a};b.prototype.processCommand=function(a){var b,e,f,c,h;c=this.handlers;h=[];e=0;for(f=c.length;e<f;e++)b=c[e],b.handles(a)?h.push(b.run(a)):h.push(void 0);return h};b.prototype.processCommands=function(a){var b,e,f,c;c=[];e=0;for(f=a.length;e<f;e++)b=a[e],c.push(this.processCommand(b));return c};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__stabilizer=function(){if(null===a){var b=function(a,b,e){this.client=a;this.organizer=b;this.processor=e};b.prototype.stabilize=function(a){var b,e,f,c,h;c=this.organizer.activeCommands();h=[];e=0;for(f=c.length;e<f;e++)b=c[e],b.timestamp<=a&&h.push(b);this.client.revertState();this.processor.processCommands(h);this.client.lockState();this.organizer.lockCommands(h);return this.processor.processCommands(this.organizer.activeCommands())};
a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__synchronizer=function(){if(null===a){var b,g=function(a,b){return function(){return a.apply(b,arguments)}};require("lib/reqwest");b=require("leonidas/commands/command");var k=function(a,b,c,h){this.syncUrl=a;this.client=b;this.organizer=c;this.stabilizer=h;this.pull=g(this.pull,this);this.push=g(this.push,this);this.externalClients=[]};k.prototype.push=function(){var a,b=this,c,h,g,k;g=this.organizer.unsyncedCommands;k=[];c=0;for(h=
g.length;c<h;c++)a=g[c],k.push(a);c=reqwest;h=""+this.syncUrl;g=this.client.id;var l,t,r;r=[];l=0;for(t=k.length;l<t;l++)a=k[l],r.push(a.toHash());return c({url:h,type:"json",method:"post",data:{clientId:g,commands:r},error:function(){return console.log("push error")},success:function(){return b.organizer.markAsSynced(k)}})};k.prototype.pull=function(){var a=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{clientId:this.client.id,clients:this.externalClients},error:function(){return console.log("pull error")},
success:function(f){var c;a.externalClients=f.data.currentClients;var g,k,s,w;s=f.data.commands;w=[];g=0;for(k=s.length;g<k;g++)c=s[g],w.push(new b(c.name,c.data,c.connection,new Date(c.timestamp)));a.organizer.addCommands(w,!1);return a.stabilizer.stabilize(f.data.stableTimestamp)}})};a=k}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null,l=function(){var a=function(){function a(d){x=d}function b(d,a){this.o=d;this.fn=a;f.apply(this,arguments)}function f(d,b){function e(a){d.timeout&&clearTimeout(g.timeout);for(g.timeout=null;0<g._completeHandlers.length;)g._completeHandlers.shift()(a)}function f(d,a,b){g._responseArgs.resp=d;g._responseArgs.msg=a;g._responseArgs.t=b;for(g._erred=!0;0<g._errorHandlers.length;)g._errorHandlers.shift()(d,a,b);e(d)}this.url="string"==typeof d?d:d.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var g=this,p;if(!(p=d.type))p=(p=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?p[1]:"js";var l=p;b=b||function(){};d.timeout&&(this.timeout=setTimeout(function(){g.abort()},d.timeout));d.success&&this._fulfillmentHandlers.push(function(){d.success.apply(d,arguments)});d.error&&this._errorHandlers.push(function(){d.error.apply(d,arguments)});d.complete&&this._completeHandlers.push(function(){d.complete.apply(d,
arguments)});var h;var t=function(d){var a=E.dataFilter(d.responseText,l);if(a=d.responseText=a)switch(l){case "json":try{d=y.JSON?y.JSON.parse(a):eval("("+a+")")}catch(c){return f(d,"Could not parse JSON in response",c)}break;case "js":d=eval(a);break;case "html":d=a;break;case "xml":d=d.responseXML&&d.responseXML.parseError&&d.responseXML.parseError.errorCode&&d.responseXML.parseError.reason?null:d.responseXML}g._responseArgs.resp=d;g._fulfilled=!0;for(b(d);0<g._fulfillmentHandlers.length;)g._fulfillmentHandlers.shift()(d);
e(d)},j=this.o,n=(j.method||"GET").toUpperCase(),u="string"===typeof j?j:j.url;p=!1!==j.processData&&j.data&&"string"!==typeof j.data?c.toQueryString(j.data):j.data||null;var q;if(("jsonp"==j.type||"GET"==n)&&p)u=u+(/\?/.test(u)?"&":"?")+p,p=null;if("jsonp"==j.type){h=u;p=J++;q=j.jsonpCallback||"callback";var n=j.jsonpCallbackName||c.getcallbackPrefix(p),u=RegExp("((^|\\?|&)"+q+")=([^&]+)"),r=h.match(u),m=F.createElement("script"),s=0,w=-1!==navigator.userAgent.indexOf("MSIE 10.0");r?"?"===r[3]?h=
h.replace(u,"$1="+n):n=r[3]:h=h+(/\?/.test(h)?"&":"?")+(q+"="+n);y[n]=a;m.type="text/javascript";m.src=h;m.async=!0;"undefined"!==typeof m.onreadystatechange&&!w&&(m.event="onclick",m.htmlFor=m.id="_reqwest_"+p);m.onload=m.onreadystatechange=function(){if(m[z]&&"complete"!==m[z]&&"loaded"!==m[z]||s)return!1;m.onload=m.onreadystatechange=null;m.onclick&&m.onclick();j.success&&j.success(x);x=void 0;C.removeChild(m);s=1};C.appendChild(m);h={abort:function(){m.onload=m.onreadystatechange=null;j.error&&
j.error({},"Request is aborted: timeout",{});x=void 0;C.removeChild(m);s=1}}}else{q=K();q.open(n,u,!0);n=j.headers||{};n.Accept=n.Accept||A.accept[j.type]||A.accept["*"];!j.crossOrigin&&!n[G]&&(n[G]=A.requestedWith);n[H]||(n[H]=j.contentType||A.contentType);for(h in n)n.hasOwnProperty(h)&&q.setRequestHeader(h,n[h]);"undefined"!==typeof j.withCredentials&&"undefined"!==typeof q.withCredentials&&(q.withCredentials=!!j.withCredentials);var v=this;q.onreadystatechange=function(){if(v._aborted)return f(v.request);
v.request&&4==v.request[z]&&(v.request.onreadystatechange=L,M.test(v.request.status)?t(v.request):f(v.request))};j.before&&j.before(q);q.send(p);h=q}this.request=h}function c(d,a){return new b(d,a)}function g(d){return d?d.replace(/\r?\n/g,"\r\n"):""}function l(d,a){var b=d.name,c=d.tagName.toLowerCase(),e=function(d){d&&!d.disabled&&a(b,g(d.attributes.value&&d.attributes.value.specified?d.value:d.text))},f;if(!d.disabled&&b)switch(c){case "input":/reset|button|image|file/i.test(d.type)||(e=/checkbox/i.test(d.type),
c=/radio/i.test(d.type),f=d.value,(!e&&!c||d.checked)&&a(b,g(e&&""===f?"on":f)));break;case "textarea":a(b,g(d.value));break;case "select":if("select-one"===d.type.toLowerCase())e(0<=d.selectedIndex?d.options[d.selectedIndex]:null);else for(c=0;d.length&&c<d.length;c++)d.options[c].selected&&e(d.options[c])}}function s(){var d,a;for(a=0;a<arguments.length;a++){d=arguments[a];/input|select|textarea/i.test(d.tagName)&&l(d,this);for(var b=["input","select","textarea"],c=void 0,e=void 0,f=void 0,c=0;c<
b.length;c++){f=d[I](b[c]);for(e=0;e<f.length;e++)l(f[e],this)}}}function w(){return c.toQueryString(c.serializeArray.apply(null,arguments))}function t(){var d={};s.apply(function(a,b){a in d?(d[a]&&!D(d[a])&&(d[a]=[d[a]]),d[a].push(b)):d[a]=b},arguments);return d}function r(d,a,b,c){var e,f,g=/\[\]$/;if(D(a))for(e=0;a&&e<a.length;e++)f=a[e],b||g.test(d)?c(d,f):r(d+"["+("object"===typeof f?e:"")+"]",f,b,c);else if("[object Object]"===a.toString())for(e in a)r(d+"["+e+"]",a[e],b,c);else c(d,a)}var y=
window,F=document,M=/^20\d$/,I="getElementsByTagName",z="readyState",H="Content-Type",G="X-Requested-With",C=F[I]("head")[0],J=0,N="reqwest_"+ +new Date,x,L=function(){},D="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},A={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},K=y.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},E={dataFilter:function(a){return a}};b.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){f.call(this,this.o,this.fn)},then:function(a,b){this._fulfilled?a(this._responseArgs.resp):this._erred?b(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(a),this._errorHandlers.push(b));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};c.serializeArray=function(){var a=[];s.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};c.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?t:"array"==a?c.serializeArray:w).apply(null,b)};c.toQueryString=function(a,b){var c,e=b||!1,f=[],g=encodeURIComponent,h=function(a,b){b="function"===typeof b?b():null==b?"":b;f[f.length]=g(a)+"="+g(b)};if(D(a))for(c=0;a&&c<a.length;c++)h(a[c].name,a[c].value);else for(c in a)r(c,a[c],e,h);return f.join("&").replace(/%20/g,"+")};c.getcallbackPrefix=function(){return N};c.compat=function(a,c){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new b(a,c)};c.ajaxSetup=function(a){a=a||{};for(var b in a)E[b]=a[b]};return c};"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):this.reqwest=a();!0};b.lib__reqwest=function(){null===a&&(a=l());return a};window.modules=b})();
(function(){var b=window.modules||[];window.require=function(a){a=a.replace(/\//g,"__");-1===a.indexOf("__")&&(a="__"+a);return null===b[a]?null:b[a]()}})();

