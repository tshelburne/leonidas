(function(){var f=window.modules||[],a=null;f.leonidas__client=function(){null===a&&(a=function(a,k,h,b){this.id=a;this.appName=k;this.state=null!=h?h:{};null==b&&(b=null);if(null==this.id)throw Error("Client Id is required");if(null==this.appName)throw Error("App Name is required");this.lastUpdate=null!=b?b:new Date(0)});return a};window.modules=f})();
(function(){var f=window.modules||[],a=null;f.leonidas__commander=function(){if(null===a){var e,k,h,b;e=require("leonidas/commands/command");k=require("leonidas/commands/organizer");h=require("leonidas/commands/processor");b=require("leonidas/commands/synchronizer");var d=function(b,g,d,h){this.client=b;this.organizer=g;this.processor=d;this.synchronizer=h};d.create=function(c,d,a){var e;e=new k;d=new h(d);a=new b(a,c,e,d);return new this(c,e,d,a)};d.prototype.startSync=function(b,d){null==b&&(b=
1E3);null==d&&(d=5E3);this.pushInterval=setInterval(this.synchronizer.push,b);return this.pullInterval=setInterval(this.synchronizer.pull,d)};d.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};d.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};d.prototype.issueCommand=function(b,d){var a;a=new e(b,d,this.client.id);this.organizer.local.addCommand(a);return this.processor.runCommand(a)};a=d}return a};window.modules=
f})();(function(){var f=window.modules||[],a=null;f.leonidas__commands__command=function(){if(null===a){var e=function(a,h,b,d){this.name=a;this.data=h;this.clientId=b;null==d&&(d=null);this.timestamp=null!=d?d:new Date};e.prototype.toHash=function(){return{name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};a=e}return a};window.modules=f})();
(function(){var f=window.modules||[],a=null;f.leonidas__commands__command_list=function(){if(null===a){var e=function(){this.commands=[]};e.prototype.addCommand=function(a){return this.commands.push(a)};e.prototype.addCommands=function(a){var h,b,d,c;c=[];b=0;for(d=a.length;b<d;b++)h=a[b],c.push(this.addCommand(h));return c};e.prototype.commandsThrough=function(a){var h,b,d,c,g;c=this.commands;g=[];b=0;for(d=c.length;b<d;b++)h=c[b],h.timestamp<=a&&g.push(h);return g};e.prototype.commandsSince=function(a){var h,
b,d,c,g;c=this.commands;g=[];b=0;for(d=c.length;b<d;b++)h=c[b],h.timestamp>a&&g.push(h);return g};a=e}return a};window.modules=f})();
(function(){var f=window.modules||[],a=null;f.leonidas__commands__handler=function(){if(null===a){var e=function(){};e.prototype.handles=function(a){return a.name===this.name};e.prototype.run=function(){throw Error("Every CommandHandler should override #run.");};e.prototype.rollback=function(){throw Error("Every CommandHandler should override #rollback.");};a=e}return a};window.modules=f})();
(function(){var f=window.modules||[],a=null;f.leonidas__commands__organizer=function(){if(null===a){var e;e=require("leonidas/commands/command_list");var k=function(){this.local=new e;this.external=new e};k.prototype.commandsThrough=function(a){var b,d,c,g,e;g=this.allCommands();e=[];d=0;for(c=g.length;d<c;d++)b=g[d],b.timestamp<=a&&e.push(b);return e};k.prototype.commandsSince=function(a){var b,d,c,g,e;g=this.allCommands();e=[];d=0;for(c=g.length;d<c;d++)b=g[d],b.timestamp>a&&e.push(b);return e};
k.prototype.allCommands=function(){var a,b,d,c,g;c=this.local.commands;g=[];b=0;for(d=c.length;b<d;b++)a=c[b],g.push(a);c=this.external.commands;b=0;for(d=c.length;b<d;b++)a=c[b],g.push(a);return g};a=k}return a};window.modules=f})();
(function(){var f=window.modules||[],a=null;f.leonidas__commands__processor=function(){if(null===a){var e=function(a){this.handlers=a};e.prototype.runCommand=function(a){var e,b,d,c,g;c=this.handlers;g=[];b=0;for(d=c.length;b<d;b++)e=c[b],e.handles(a)?g.push(e.run(a)):g.push(void 0);return g};e.prototype.runCommands=function(a){var e,b,d,c;a.sort(function(b,a){return b.timestamp>a.timestamp?1:-1});c=[];b=0;for(d=a.length;b<d;b++)e=a[b],c.push(this.runCommand(e));return c};e.prototype.rollbackCommand=
function(a){var e,b,d,c,g;c=this.handlers;g=[];b=0;for(d=c.length;b<d;b++)e=c[b],e.handles(a)?g.push(e.rollback(a)):g.push(void 0);return g};e.prototype.rollbackCommands=function(a){var e,b,d,c;a.sort(function(b,a){return b.timestamp<a.timestamp?1:-1});c=[];b=0;for(d=a.length;b<d;b++)e=a[b],c.push(this.rollbackCommand(e));return c};a=e}return a};window.modules=f})();
(function(){var f=window.modules||[],a=null;f.leonidas__commands__synchronizer=function(){if(null===a){var e,f=function(b,a){return function(){return b.apply(a,arguments)}};require("lib/reqwest");e=require("leonidas/commands/command");var h=function(b,a,c,e){this.syncUrl=b;this.client=a;this.organizer=c;this.processor=e;this.pull=f(this.pull,this);this.push=f(this.push,this);this.stableTimestamp=new Date(0);this.externalClients=[]};h.prototype.push=function(){var a,d=this,c,e,f,h;f=this.organizer.local.commandsSince(this.client.lastUpdate);
h=[];c=0;for(e=f.length;c<e;c++)a=f[c],h.push(a);if(0!==h.length){c=reqwest;e=""+this.syncUrl;f=this.client.appName;var k=this.client.id,u=this.externalClients,r,v,x;x=[];r=0;for(v=h.length;r<v;r++)a=h[r],x.push(a.toHash());return c({url:e,type:"json",method:"post",data:{appName:f,clientId:k,clients:u,commands:x},error:function(){return console.log("push error")},success:function(){var c;c=Math.max.apply(d,function(){var c,d,e;e=[];c=0;for(d=h.length;c<d;c++)a=h[c],e.push(a.timestamp);return e}());
return d.client.lastUpdate=new Date(c)}})}};h.prototype.pull=function(){var a=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{appName:this.client.appName,clientId:this.client.id,clients:this.externalClients},error:function(){return console.log("pull error")},success:function(d){var c,g,f,h,k;h=d.data.commands;k=[];g=0;for(f=h.length;g<f;g++)c=h[g],k.push(new e(c.name,c.data,c.connection,new Date(c.timestamp)));a.processor.rollbackCommands(a.organizer.commandsSince(a.stableTimestamp));
a.organizer.external.addCommands(k);a.processor.runCommands(a.organizer.commandsSince(a.stableTimestamp));a.externalClients=d.data.currentClients;return a.stableTimestamp=d.data.stableTimestamp}})};a=h}return a};window.modules=f})();
(function(){var f=window.modules||[],a=null,e=function(){var a=function(){function a(j){A=j}function b(a,b){this.o=a;this.fn=b;d.apply(this,arguments)}function d(j,b){function d(a){j.timeout&&clearTimeout(f.timeout);for(f.timeout=null;0<f._completeHandlers.length;)f._completeHandlers.shift()(a)}function e(a,j,b){f._responseArgs.resp=a;f._responseArgs.msg=j;f._responseArgs.t=b;for(f._erred=!0;0<f._errorHandlers.length;)f._errorHandlers.shift()(a,j,b);d(a)}this.url="string"==typeof j?j:j.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var f=this,g;if(!(g=j.type))g=(g=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?g[1]:"js";var k=g;b=b||function(){};j.timeout&&(this.timeout=setTimeout(function(){f.abort()},j.timeout));j.success&&this._fulfillmentHandlers.push(function(){j.success.apply(j,arguments)});j.error&&this._errorHandlers.push(function(){j.error.apply(j,arguments)});j.complete&&this._completeHandlers.push(function(){j.complete.apply(j,
arguments)});var p;var r=function(a){var j=E.dataFilter(a.responseText,k);if(j=a.responseText=j)switch(k){case "json":try{a=v.JSON?v.JSON.parse(j):eval("("+j+")")}catch(c){return e(a,"Could not parse JSON in response",c)}break;case "js":a=eval(j);break;case "html":a=j;break;case "xml":a=a.responseXML&&a.responseXML.parseError&&a.responseXML.parseError.errorCode&&a.responseXML.parseError.reason?null:a.responseXML}f._responseArgs.resp=a;f._fulfilled=!0;for(b(a);0<f._fulfillmentHandlers.length;)f._fulfillmentHandlers.shift()(a);
d(a)},l=this.o,n=(l.method||"GET").toUpperCase(),s="string"===typeof l?l:l.url;g=!1!==l.processData&&l.data&&"string"!==typeof l.data?c.toQueryString(l.data):l.data||null;var q;if(("jsonp"==l.type||"GET"==n)&&g)s=s+(/\?/.test(s)?"&":"?")+g,g=null;if("jsonp"==l.type){p=s;g=I++;q=l.jsonpCallback||"callback";var n=l.jsonpCallbackName||c.getcallbackPrefix(g),s=RegExp("((^|\\?|&)"+q+")=([^&]+)"),u=p.match(s),m=x.createElement("script"),w=0,y=-1!==navigator.userAgent.indexOf("MSIE 10.0");u?"?"===u[3]?p=
p.replace(s,"$1="+n):n=u[3]:p=p+(/\?/.test(p)?"&":"?")+(q+"="+n);v[n]=a;m.type="text/javascript";m.src=p;m.async=!0;"undefined"!==typeof m.onreadystatechange&&!y&&(m.event="onclick",m.htmlFor=m.id="_reqwest_"+g);m.onload=m.onreadystatechange=function(){if(m[z]&&"complete"!==m[z]&&"loaded"!==m[z]||w)return!1;m.onload=m.onreadystatechange=null;m.onclick&&m.onclick();l.success&&l.success(A);A=void 0;C.removeChild(m);w=1};C.appendChild(m);p={abort:function(){m.onload=m.onreadystatechange=null;l.error&&
l.error({},"Request is aborted: timeout",{});A=void 0;C.removeChild(m);w=1}}}else{q=J();q.open(n,s,!0);n=l.headers||{};n.Accept=n.Accept||B.accept[l.type]||B.accept["*"];!l.crossOrigin&&!n[F]&&(n[F]=B.requestedWith);n[D]||(n[D]=l.contentType||B.contentType);for(p in n)n.hasOwnProperty(p)&&q.setRequestHeader(p,n[p]);"undefined"!==typeof l.withCredentials&&"undefined"!==typeof q.withCredentials&&(q.withCredentials=!!l.withCredentials);var t=this;q.onreadystatechange=function(){if(t._aborted)return e(t.request);
t.request&&4==t.request[z]&&(t.request.onreadystatechange=K,H.test(t.request.status)?r(t.request):e(t.request))};l.before&&l.before(q);q.send(g);p=q}this.request=p}function c(a,c){return new b(a,c)}function e(a){return a?a.replace(/\r?\n/g,"\r\n"):""}function f(a,b){var c=a.name,d=a.tagName.toLowerCase(),h=function(a){a&&!a.disabled&&b(c,e(a.attributes.value&&a.attributes.value.specified?a.value:a.text))},k;if(!a.disabled&&c)switch(d){case "input":/reset|button|image|file/i.test(a.type)||(h=/checkbox/i.test(a.type),
d=/radio/i.test(a.type),k=a.value,(!h&&!d||a.checked)&&b(c,e(h&&""===k?"on":k)));break;case "textarea":b(c,e(a.value));break;case "select":if("select-one"===a.type.toLowerCase())h(0<=a.selectedIndex?a.options[a.selectedIndex]:null);else for(d=0;a.length&&d<a.length;d++)a.options[d].selected&&h(a.options[d])}}function k(){var a,b;for(b=0;b<arguments.length;b++){a=arguments[b];/input|select|textarea/i.test(a.tagName)&&f(a,this);for(var c=["input","select","textarea"],d=void 0,e=void 0,g=void 0,d=0;d<
c.length;d++){g=a[y](c[d]);for(e=0;e<g.length;e++)f(g[e],this)}}}function G(){return c.toQueryString(c.serializeArray.apply(null,arguments))}function u(){var a={};k.apply(function(b,c){b in a?(a[b]&&!w(a[b])&&(a[b]=[a[b]]),a[b].push(c)):a[b]=c},arguments);return a}function r(a,b,c,d){var e,f,g=/\[\]$/;if(w(b))for(e=0;b&&e<b.length;e++)f=b[e],c||g.test(a)?d(a,f):r(a+"["+("object"===typeof f?e:"")+"]",f,c,d);else if("[object Object]"===b.toString())for(e in b)r(a+"["+e+"]",b[e],c,d);else d(a,b)}var v=
window,x=document,H=/^20\d$/,y="getElementsByTagName",z="readyState",D="Content-Type",F="X-Requested-With",C=x[y]("head")[0],I=0,L="reqwest_"+ +new Date,A,K=function(){},w="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},B={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},J=v.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},E={dataFilter:function(a){return a}};b.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){d.call(this,this.o,this.fn)},then:function(a,b){this._fulfilled?a(this._responseArgs.resp):this._erred?b(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(a),this._errorHandlers.push(b));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};c.serializeArray=function(){var a=[];k.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};c.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?u:"array"==a?c.serializeArray:G).apply(null,b)};c.toQueryString=function(a,b){var c,d=b||!1,e=[],f=encodeURIComponent,g=function(a,b){b="function"===typeof b?b():null==b?"":b;e[e.length]=f(a)+"="+f(b)};if(w(a))for(c=0;a&&c<a.length;c++)g(a[c].name,a[c].value);else for(c in a)r(c,a[c],d,g);return e.join("&").replace(/%20/g,"+")};c.getcallbackPrefix=function(){return L};c.compat=function(a,c){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new b(a,c)};c.ajaxSetup=function(a){a=a||{};for(var b in a)E[b]=a[b]};return c};"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):this.reqwest=a();!0};f.lib__reqwest=function(){null===a&&(a=e());return a};window.modules=f})();
(function(){var f=window.modules||[];window.require=function(a){a=a.replace(/\//g,"__");-1===a.indexOf("__")&&(a="__"+a);return null===f[a]?null:f[a]()}})();

