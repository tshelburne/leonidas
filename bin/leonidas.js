(function(){var h=window.modules||[],b=null;h.leonidas__client=function(){null===b&&(b=function(b,e,j,c){this.id=b;this.appName=e;this.appType=null!=j?j:"";null==c&&(c=null);if(null==this.id)throw Error("Client Id is required");if(null==this.appName)throw Error("App Name is required");this.lastUpdate=null!=c?c:0});return b};window.modules=h})();
(function(){var h=window.modules||[],b=null;h.leonidas__commander=function(){if(null===b){var k,e,j,c;k=require("leonidas/commands/command");e=require("leonidas/commands/organizer");j=require("leonidas/commands/processor");c=require("leonidas/commands/synchronizer");var a=function(d,a,c,e){this.client=d;this.organizer=a;this.processor=c;this.synchronizer=e};a.create=function(d,a,f){var b;b=new e;a=new j(a);f=new c(f,d,b,a);return new this(d,b,a,f)};a.prototype.startSync=function(a,c){null==a&&(a=
1E3);null==c&&(c=5E3);this.pushInterval=setInterval(this.synchronizer.push,a);return this.pullInterval=setInterval(this.synchronizer.pull,c)};a.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};a.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};a.prototype.issueCommand=function(a,c){var f;f=new k(a,c,this.client.id);this.organizer.local.addCommand(f);return this.processor.runCommand(f)};b=a}return b};window.modules=
h})();
(function(){var h=window.modules||[],b=null;h.leonidas__commands__command=function(){if(null===b){var k=function(b,j,c,a,d){this.name=b;this.data=j;this.clientId=c;null==a&&(a=null);this.id=null!=d?d:null;this.timestamp=null!=a?a:new Date;this.hasBeenRun=!1};k.prototype.hasRun=function(){return this.hasBeenRun};k.prototype.markAsRun=function(){return this.hasBeenRun=!0};k.prototype.markAsNotRun=function(){return this.hasBeenRun=!1};k.prototype.toHash=function(){return{id:this.id,name:this.name,data:this.data,
clientId:this.clientId,timestamp:this.timestamp.getTime()}};b=k}return b};window.modules=h})();
(function(){var h=window.modules||[],b=null;h.leonidas__commands__command_list=function(){if(null===b){var k=[].indexOf||function(c){for(var a=0,d=this.length;a<d;a++)if(a in this&&this[a]===c)return a;return-1},e=function(){this.commands=[]},j;e.prototype.addCommand=function(c){null==c.id&&(c.id=j(this.commands));return this.commands.push(c)};e.prototype.addCommands=function(c){var a,d,g,f;f=[];d=0;for(g=c.length;d<g;d++)a=c[d],f.push(this.addCommand(a));return f};e.prototype.commandsThrough=function(c){var a,
d,g,f,b;f=this.commands;b=[];d=0;for(g=f.length;d<g;d++)a=f[d],a.timestamp<=c&&b.push(a);return b};e.prototype.commandsSince=function(c){var a,d,g,f,b;f=this.commands;b=[];d=0;for(g=f.length;d<g;d++)a=f[d],a.timestamp>c&&b.push(a);return b};j=function(c){var a,d;for(a=""+(new Date).getTime()+"-"+c.length;0<=k.call(function(){var a,f,b;b=[];a=0;for(f=c.length;a<f;a++)d=c[a],b.push(d.id);return b}(),a);)a=""+(new Date).getTime()+"-"+c.length;return a};b=e}return b};window.modules=h})();
(function(){var h=window.modules||[],b=null;h.leonidas__commands__handler=function(){if(null===b){var k=function(){};k.prototype.handles=function(b){return b.name===this.name};k.prototype.run=function(){throw Error("Every CommandHandler should override #run.");};k.prototype.rollback=function(){throw Error("Every CommandHandler should override #rollback.");};b=k}return b};window.modules=h})();
(function(){var h=window.modules||[],b=null;h.leonidas__commands__organizer=function(){if(null===b){var k;k=require("leonidas/commands/command_list");var e=function(){this.local=new k;this.external=new k};e.prototype.commandsFrom=function(b){var c,a,d,g,f;g=this.allCommands();f=[];a=0;for(d=g.length;a<d;a++)c=g[a],c.timestamp>=b&&f.push(c);return f};e.prototype.commandsThrough=function(b){var c,a,d,g,f;g=this.allCommands();f=[];a=0;for(d=g.length;a<d;a++)c=g[a],c.timestamp<=b&&f.push(c);return f};
e.prototype.commandsSince=function(b){var c,a,d,g,f;g=this.allCommands();f=[];a=0;for(d=g.length;a<d;a++)c=g[a],c.timestamp>b&&f.push(c);return f};e.prototype.commandsTo=function(b){var c,a,d,g,f;g=this.allCommands();f=[];a=0;for(d=g.length;a<d;a++)c=g[a],c.timestamp<b&&f.push(c);return f};e.prototype.allCommands=function(){var b,c,a,d,g;d=this.local.commands;g=[];c=0;for(a=d.length;c<a;c++)b=d[c],g.push(b);d=this.external.commands;c=0;for(a=d.length;c<a;c++)b=d[c],g.push(b);return g};e.prototype.commandsFor=
function(b,c){var a,d,g,f,e;null==c&&(c=null);null==c&&(c=new Date(0));f=this.commandsSince(c);e=[];d=0;for(g=f.length;d<g;d++)a=f[d],a.clientId===b&&e.push(a);return e};b=e}return b};window.modules=h})();
(function(){var h=window.modules||[],b=null;h.leonidas__commands__processor=function(){if(null===b){var k=function(b){this.handlers=b};k.prototype.runCommand=function(b){var j,c,a,d,g;d=this.handlers;g=[];c=0;for(a=d.length;c<a;c++)j=d[c],j.handles(b)?g.push(j.run(b)):g.push(void 0);return g};k.prototype.runCommands=function(b){var j,c,a,d;b.sort(function(a,d){return a.timestamp>d.timestamp?1:-1});d=[];c=0;for(a=b.length;c<a;c++)j=b[c],d.push(this.runCommand(j));return d};k.prototype.rollbackCommand=
function(b){var j,c,a,d,g;d=this.handlers;g=[];c=0;for(a=d.length;c<a;c++)j=d[c],j.handles(b)?g.push(j.rollback(b)):g.push(void 0);return g};k.prototype.rollbackCommands=function(b){var j,c,a,d;b.sort(function(a,d){return a.timestamp<d.timestamp?1:-1});d=[];c=0;for(a=b.length;c<a;c++)j=b[c],d.push(this.rollbackCommand(j));return d};b=k}return b};window.modules=h})();
(function(){var h=window.modules||[],b=null;h.leonidas__commands__synchronizer=function(){if(null===b){var k,e=function(a,d){return function(){return a.apply(d,arguments)}};require("lib/reqwest");k=require("leonidas/commands/command");var j=function(a,d,b,c){this.syncUrl=a;this.client=d;this.organizer=b;this.processor=c;this.reconcile=e(this.reconcile,this);this.push=e(this.push,this);this.pull=e(this.pull,this);this.stableTimestamp=0;this.externalClients={};this.lastPushAttempt=0},c;j.prototype.pull=
function(){var a=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{appName:this.client.appName,appType:this.client.appType,clientId:this.client.id,externalClients:this.externalClients},error:function(){return console.log("pull error")},success:function(d){var b,c,e,j,h;if(d.success){if(0<d.data.commands.length){var r;j=d.data.commands;r=[];b=0;for(e=j.length;b<e;b++)c=j[b],r.push(new k(c.name,c.data,c.clientId,new Date(c.timestamp),c.id));b=Math.min.apply(Math,function(){var a,
b,d;d=[];a=0;for(b=r.length;a<b;a++)c=r[a],d.push(c.timestamp);return d}());a.processor.rollbackCommands(a.organizer.commandsFrom(b));a.organizer.external.addCommands(r);a.processor.runCommands(a.organizer.commandsFrom(b))}h=d.data.externalClients;e=0;for(j=h.length;e<j;e++)b=h[e],a.externalClients[b.id]=b.lastUpdate;return a.stableTimestamp=d.data.stableTimestamp}if("reconcile required"===d.message&&null==a.reconcileTimeout)return a.reconcileTimeout=setTimeout(a.reconcile,1E3)}})};j.prototype.push=
function(){var a,b=this,g,f,e,j;e=this.organizer.local.commandsSince(this.client.lastUpdate);j=[];g=0;for(f=e.length;g<f;g++)a=e[g],j.push(a);if(0!==j.length)return this.lastPushAttempt=(new Date).valueOf(),reqwest({url:""+this.syncUrl,type:"json",method:"post",data:{appName:this.client.appName,appType:this.client.appType,clientId:this.client.id,pushedAt:this.lastPushAttempt,commands:c(j)},error:function(){return console.log("push error")},success:function(a){if(a.success)return b.client.lastUpdate=
b.lastPushAttempt;if("reconcile required"===a.message&&null==b.reconcileTimeout)return b.reconcileTimeout=setTimeout(b.reconcile,1E3)}})};j.prototype.reconcile=function(){var a,b,g,f=this;a={};a[this.client.id]=c(this.organizer.local.commands);for(g in this.externalClients)b=this.organizer.commandsFor(g),a[g]=c(b);return reqwest({url:""+this.syncUrl+"/reconcile",type:"json",method:"post",data:{appName:this.client.appName,appType:this.client.appType,clientId:this.client.id,externalClients:this.externalClients,
commandList:a,stableTimestamp:this.stableTimestamp},error:function(){return console.log("reconcile error")},success:function(a){if(a.success)return clearInterval(f.reconcileTimeout),f.reconcileTimeout=null;if("reconcile required"===a.message)return f.reconcileTimeout=setTimeout(f.reconcile,1E3)}})};c=function(a){var b,c,f,e;c={};f=0;for(e=a.length;f<e;f++)b=a[f],c[b.id]=b.toHash();return c};b=j}return b};window.modules=h})();
(function(){var h=window.modules||[],b=null,k=function(){var b=function(){function b(a){w=a}function c(b,c){this.o=b;this.fn=c;a.apply(this,arguments)}function a(a,c){function f(b){a.timeout&&clearTimeout(e.timeout);for(e.timeout=null;0<e._completeHandlers.length;)e._completeHandlers.shift()(b)}function g(a,b,c){e._responseArgs.resp=a;e._responseArgs.msg=b;e._responseArgs.t=c;for(e._erred=!0;0<e._errorHandlers.length;)e._errorHandlers.shift()(a,b,c);f(a)}this.url="string"==typeof a?a:a.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var e=this,h;if(!(h=a.type))h=(h=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?h[1]:"js";var k=h;c=c||function(){};a.timeout&&(this.timeout=setTimeout(function(){e.abort()},a.timeout));a.success&&this._fulfillmentHandlers.push(function(){a.success.apply(a,arguments)});a.error&&this._errorHandlers.push(function(){a.error.apply(a,arguments)});a.complete&&this._completeHandlers.push(function(){a.complete.apply(a,
arguments)});var p;var r=function(a){var b=D.dataFilter(a.responseText,k);if(b=a.responseText=b)switch(k){case "json":try{a=v.JSON?v.JSON.parse(b):eval("("+b+")")}catch(d){return g(a,"Could not parse JSON in response",d)}break;case "js":a=eval(b);break;case "html":a=b;break;case "xml":a=a.responseXML&&a.responseXML.parseError&&a.responseXML.parseError.errorCode&&a.responseXML.parseError.reason?null:a.responseXML}e._responseArgs.resp=a;e._fulfilled=!0;for(c(a);0<e._fulfillmentHandlers.length;)e._fulfillmentHandlers.shift()(a);
f(a)},l=this.o,n=(l.method||"GET").toUpperCase(),s="string"===typeof l?l:l.url;h=!1!==l.processData&&l.data&&"string"!==typeof l.data?d.toQueryString(l.data):l.data||null;var q;if(("jsonp"==l.type||"GET"==n)&&h)s=s+(/\?/.test(s)?"&":"?")+h,h=null;if("jsonp"==l.type){p=s;h=H++;q=l.jsonpCallback||"callback";var n=l.jsonpCallbackName||d.getcallbackPrefix(h),s=RegExp("((^|\\?|&)"+q+")=([^&]+)"),u=p.match(s),m=C.createElement("script"),A=0,z=-1!==navigator.userAgent.indexOf("MSIE 10.0");u?"?"===u[3]?p=
p.replace(s,"$1="+n):n=u[3]:p=p+(/\?/.test(p)?"&":"?")+(q+"="+n);v[n]=b;m.type="text/javascript";m.src=p;m.async=!0;"undefined"!==typeof m.onreadystatechange&&!z&&(m.event="onclick",m.htmlFor=m.id="_reqwest_"+h);m.onload=m.onreadystatechange=function(){if(m[x]&&"complete"!==m[x]&&"loaded"!==m[x]||A)return!1;m.onload=m.onreadystatechange=null;m.onclick&&m.onclick();l.success&&l.success(w);w=void 0;B.removeChild(m);A=1};B.appendChild(m);p={abort:function(){m.onload=m.onreadystatechange=null;l.error&&
l.error({},"Request is aborted: timeout",{});w=void 0;B.removeChild(m);A=1}}}else{q=I();q.open(n,s,!0);n=l.headers||{};n.Accept=n.Accept||y.accept[l.type]||y.accept["*"];!l.crossOrigin&&!n[E]&&(n[E]=y.requestedWith);n[F]||(n[F]=l.contentType||y.contentType);for(p in n)n.hasOwnProperty(p)&&q.setRequestHeader(p,n[p]);"undefined"!==typeof l.withCredentials&&"undefined"!==typeof q.withCredentials&&(q.withCredentials=!!l.withCredentials);var t=this;q.onreadystatechange=function(){if(t._aborted)return g(t.request);
t.request&&4==t.request[x]&&(t.request.onreadystatechange=J,G.test(t.request.status)?r(t.request):g(t.request))};l.before&&l.before(q);q.send(h);p=q}this.request=p}function d(a,b){return new c(a,b)}function g(a){return a?a.replace(/\r?\n/g,"\r\n"):""}function f(a,b){var c=a.name,d=a.tagName.toLowerCase(),e=function(a){a&&!a.disabled&&b(c,g(a.attributes.value&&a.attributes.value.specified?a.value:a.text))},f;if(!a.disabled&&c)switch(d){case "input":/reset|button|image|file/i.test(a.type)||(e=/checkbox/i.test(a.type),
d=/radio/i.test(a.type),f=a.value,(!e&&!d||a.checked)&&b(c,g(e&&""===f?"on":f)));break;case "textarea":b(c,g(a.value));break;case "select":if("select-one"===a.type.toLowerCase())e(0<=a.selectedIndex?a.options[a.selectedIndex]:null);else for(d=0;a.length&&d<a.length;d++)a.options[d].selected&&e(a.options[d])}}function e(){var a,b;for(b=0;b<arguments.length;b++){a=arguments[b];/input|select|textarea/i.test(a.tagName)&&f(a,this);for(var c=["input","select","textarea"],d=void 0,g=void 0,h=void 0,d=0;d<
c.length;d++){h=a[z](c[d]);for(g=0;g<h.length;g++)f(h[g],this)}}}function h(){return d.toQueryString(d.serializeArray.apply(null,arguments))}function k(){var a={};e.apply(function(b,c){b in a?(a[b]&&!u(a[b])&&(a[b]=[a[b]]),a[b].push(c)):a[b]=c},arguments);return a}function r(a,b,c,d){var e,f,g=/\[\]$/;if(u(b))for(e=0;b&&e<b.length;e++)f=b[e],c||g.test(a)?d(a,f):r(a+"["+("object"===typeof f?e:"")+"]",f,c,d);else if("[object Object]"===b.toString())for(e in b)r(a+"["+e+"]",b[e],c,d);else d(a,b)}var v=
window,C=document,G=/^20\d$/,z="getElementsByTagName",x="readyState",F="Content-Type",E="X-Requested-With",B=C[z]("head")[0],H=0,K="reqwest_"+ +new Date,w,J=function(){},u="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},y={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},I=v.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},D={dataFilter:function(a){return a}};c.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){a.call(this,this.o,this.fn)},then:function(a,b){this._fulfilled?a(this._responseArgs.resp):this._erred?b(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(a),this._errorHandlers.push(b));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};d.serializeArray=function(){var a=[];e.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};d.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?k:"array"==a?d.serializeArray:h).apply(null,b)};d.toQueryString=function(a,b){var c,d=b||!1,e=[],f=encodeURIComponent,g=function(a,b){b="function"===typeof b?b():null==b?"":b;e[e.length]=f(a)+"="+f(b)};if(u(a))for(c=0;a&&c<a.length;c++)g(a[c].name,a[c].value);else for(c in a)r(c,a[c],d,g);return e.join("&").replace(/%20/g,"+")};d.getcallbackPrefix=function(){return K};d.compat=function(a,b){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new c(a,b)};d.ajaxSetup=function(a){a=a||{};for(var b in a)D[b]=a[b]};return d};"undefined"!=typeof module&&module.exports?module.exports=b():"function"==typeof define&&define.amd?define(b):this.reqwest=b();!0};h.lib__reqwest=function(){null===b&&(b=k());return b};window.modules=h})();
(function(){var h=window.modules||[];window.require=function(b){b=b.replace(/\//g,"__");-1===b.indexOf("__")&&(b="__"+b);return null===h[b]?null:h[b]()}})();

