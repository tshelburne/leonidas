(function(){var e=window.modules||[],a=null;e.leonidas__client=function(){null===a&&(a=function(a,f,k,b){this.id=a;this.appName=f;this.state=null!=k?k:{};null==b&&(b=null);if(null==this.id)throw Error("Client Id is required");if(null==this.appName)throw Error("App Name is required");this.lastUpdate=null!=b?b:new Date(0)});return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commander=function(){if(null===a){var e,f,k,b;e=require("leonidas/commands/command");f=require("leonidas/commands/organizer");k=require("leonidas/commands/processor");b=require("leonidas/commands/synchronizer");var c=function(b,c,h,a){this.client=b;this.organizer=c;this.processor=h;this.synchronizer=a};c.create=function(d,c,h){var a;a=new f;c=new k(c);h=new b(h,d,a,c);return new this(d,a,c,h)};c.prototype.startSync=function(b,c){null==b&&(b=
1E3);null==c&&(c=5E3);this.pushInterval=setInterval(this.synchronizer.push,b);return this.pullInterval=setInterval(this.synchronizer.pull,c)};c.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};c.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};c.prototype.issueCommand=function(b,c){var h;h=new e(b,c,this.client.id);this.organizer.local.addCommand(h);return this.processor.runCommand(h)};a=c}return a};window.modules=
e})();(function(){var e=window.modules||[],a=null;e.leonidas__commands__command=function(){if(null===a){var e=function(a,k,b,c,d){this.name=a;this.data=k;this.clientId=b;null==c&&(c=null);this.id=null!=d?d:null;this.timestamp=null!=c?c:new Date};e.prototype.toHash=function(){return{id:this.id,name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};a=e}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__command_list=function(){if(null===a){var e=[].indexOf||function(b){for(var c=0,d=this.length;c<d;c++)if(c in this&&this[c]===b)return c;return-1},f=function(){this.commands=[]},k;f.prototype.addCommand=function(b){null===b.id&&(b.id=k(this.commands));return this.commands.push(b)};f.prototype.addCommands=function(b){var c,d,g,h;h=[];d=0;for(g=b.length;d<g;d++)c=b[d],h.push(this.addCommand(c));return h};f.prototype.commandsThrough=function(b){var c,
d,g,h,a;h=this.commands;a=[];d=0;for(g=h.length;d<g;d++)c=h[d],c.timestamp<=b&&a.push(c);return a};f.prototype.commandsSince=function(b){var c,d,g,a,f;a=this.commands;f=[];d=0;for(g=a.length;d<g;d++)c=a[d],c.timestamp>b&&f.push(c);return f};k=function(b){c;for(var c,d;0<=e.call(function(){var c,a,f;f=[];c=0;for(a=b.length;c<a;c++)d=b[c],f.push(d.id);return f}(),c);)c=""+(new Date).getTime()+"-"+b.length;return c};a=f}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__handler=function(){if(null===a){var e=function(){};e.prototype.handles=function(a){return a.name===this.name};e.prototype.run=function(){throw Error("Every CommandHandler should override #run.");};e.prototype.rollback=function(){throw Error("Every CommandHandler should override #rollback.");};a=e}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__organizer=function(){if(null===a){var e;e=require("leonidas/commands/command_list");var f=function(){this.local=new e;this.external=new e};f.prototype.commandsThrough=function(a){var b,c,d,g,h;g=this.allCommands();h=[];c=0;for(d=g.length;c<d;c++)b=g[c],b.timestamp<=a&&h.push(b);return h};f.prototype.commandsSince=function(a){var b,c,d,g,h;g=this.allCommands();h=[];c=0;for(d=g.length;c<d;c++)b=g[c],b.timestamp>a&&h.push(b);return h};
f.prototype.allCommands=function(){var a,b,c,d,g;d=this.local.commands;g=[];b=0;for(c=d.length;b<c;b++)a=d[b],g.push(a);d=this.external.commands;b=0;for(c=d.length;b<c;b++)a=d[b],g.push(a);return g};f.prototype.commandsFor=function(a,b){var c,d,g,h,f;null==b&&(b=null);null===b&&(b=new Date(0));h=this.commandsSince(b);f=[];d=0;for(g=h.length;d<g;d++)c=h[d],c.clientId===a&&f.push(c);return f};a=f}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__processor=function(){if(null===a){var e=function(a){this.handlers=a};e.prototype.runCommand=function(a){var e,b,c,d,g;d=this.handlers;g=[];b=0;for(c=d.length;b<c;b++)e=d[b],e.handles(a)?g.push(e.run(a)):g.push(void 0);return g};e.prototype.runCommands=function(a){var e,b,c,d;a.sort(function(b,c){return b.timestamp>c.timestamp?1:-1});d=[];b=0;for(c=a.length;b<c;b++)e=a[b],d.push(this.runCommand(e));return d};e.prototype.rollbackCommand=
function(a){var e,b,c,d,g;d=this.handlers;g=[];b=0;for(c=d.length;b<c;b++)e=d[b],e.handles(a)?g.push(e.rollback(a)):g.push(void 0);return g};e.prototype.rollbackCommands=function(a){var e,b,c,d;a.sort(function(b,c){return b.timestamp<c.timestamp?1:-1});d=[];b=0;for(c=a.length;b<c;b++)e=a[b],d.push(this.rollbackCommand(e));return d};a=e}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__synchronizer=function(){if(null===a){var e,f=function(b,c){return function(){return b.apply(c,arguments)}};require("lib/reqwest");e=require("leonidas/commands/command");var k=function(b,c,d,a){this.syncUrl=b;this.client=c;this.organizer=d;this.processor=a;this.reconcile=f(this.reconcile,this);this.pull=f(this.pull,this);this.push=f(this.push,this);this.stableTimestamp=new Date(0);this.externalClients=[]};k.prototype.push=function(){var b,
c=this,a,e,h,f;h=this.organizer.local.commandsSince(this.client.lastUpdate);f=[];a=0;for(e=h.length;a<e;a++)b=h[a],f.push(b);if(0!==f.length){a=reqwest;e=""+this.syncUrl;h=this.client.appName;var k=this.client.id,n=this.externalClients,q,u,v;v=[];q=0;for(u=f.length;q<u;q++)b=f[q],v.push(b.toHash());return a({url:e,type:"json",method:"post",data:{appName:h,clientId:k,clients:n,commands:v},error:function(){return console.log("push error")},success:function(){var a;a=Math.max.apply(c,function(){var a,
c,d;d=[];a=0;for(c=f.length;a<c;a++)b=f[a],d.push(b.timestamp);return d}());return c.client.lastUpdate=new Date(a)}})}};k.prototype.pull=function(){var b=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{appName:this.client.appName,clientId:this.client.id,clients:this.externalClients},error:function(){return console.log("pull error")},success:function(a){var d,g,h,f,k;f=a.data.commands;k=[];g=0;for(h=f.length;g<h;g++)d=f[g],k.push(new e(d.name,d.data,d.connection,new Date(d.timestamp),
d.id));b.processor.rollbackCommands(b.organizer.commandsSince(b.stableTimestamp));b.organizer.external.addCommands(k);b.processor.runCommands(b.organizer.commandsSince(b.stableTimestamp));b.externalClients=a.data.currentClients;return b.stableTimestamp=a.data.stableTimestamp}})};k.prototype.reconcile=function(){var a,c,d,e,f,k=this;c={};d=this.client.id;var t,n;t=this.organizer.local.commands;n=[];e=0;for(f=t.length;e<f;e++)a=t[e],n.push(a.toHash());c[d]=n;e=0;for(f=externalClients.length;e<f;e++){a=
externalClients[e];d=this.organizer.commandsFor(a.id);t=c;n=""+a.id;for(var q=void 0,u=void 0,v=void 0,v=[],q=0,u=d.length;q<u;q++)a=d[q],v.push(a.toHash());t[n]=v}return reqwest({url:""+syncUrl+"/reconcile",type:"json",method:"post",data:{appName:this.client.appName,clientId:this.client.id,commandList:c,stableTimestamp:this.stableTimestamp},error:function(){return console.log("reconcile error")},success:function(){return clearInterval(k.reconcileInterval)}})};a=k}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null,C=function(){var a=function(){function a(j){A=j}function b(a,b){this.o=a;this.fn=b;c.apply(this,arguments)}function c(j,b){function c(a){j.timeout&&clearTimeout(f.timeout);for(f.timeout=null;0<f._completeHandlers.length;)f._completeHandlers.shift()(a)}function e(a,j,b){f._responseArgs.resp=a;f._responseArgs.msg=j;f._responseArgs.t=b;for(f._erred=!0;0<f._errorHandlers.length;)f._errorHandlers.shift()(a,j,b);c(a)}this.url="string"==typeof j?j:j.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var f=this,g;if(!(g=j.type))g=(g=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?g[1]:"js";var h=g;b=b||function(){};j.timeout&&(this.timeout=setTimeout(function(){f.abort()},j.timeout));j.success&&this._fulfillmentHandlers.push(function(){j.success.apply(j,arguments)});j.error&&this._errorHandlers.push(function(){j.error.apply(j,arguments)});j.complete&&this._completeHandlers.push(function(){j.complete.apply(j,
arguments)});var r;var q=function(a){var j=G.dataFilter(a.responseText,h);if(j=a.responseText=j)switch(h){case "json":try{a=u.JSON?u.JSON.parse(j):eval("("+j+")")}catch(d){return e(a,"Could not parse JSON in response",d)}break;case "js":a=eval(j);break;case "html":a=j;break;case "xml":a=a.responseXML&&a.responseXML.parseError&&a.responseXML.parseError.errorCode&&a.responseXML.parseError.reason?null:a.responseXML}f._responseArgs.resp=a;f._fulfilled=!0;for(b(a);0<f._fulfillmentHandlers.length;)f._fulfillmentHandlers.shift()(a);
c(a)},l=this.o,p=(l.method||"GET").toUpperCase(),n="string"===typeof l?l:l.url;g=!1!==l.processData&&l.data&&"string"!==typeof l.data?d.toQueryString(l.data):l.data||null;var s;if(("jsonp"==l.type||"GET"==p)&&g)n=n+(/\?/.test(n)?"&":"?")+g,g=null;if("jsonp"==l.type){r=n;g=I++;s=l.jsonpCallback||"callback";var p=l.jsonpCallbackName||d.getcallbackPrefix(g),n=RegExp("((^|\\?|&)"+s+")=([^&]+)"),t=r.match(n),m=v.createElement("script"),x=0,y=-1!==navigator.userAgent.indexOf("MSIE 10.0");t?"?"===t[3]?r=
r.replace(n,"$1="+p):p=t[3]:r=r+(/\?/.test(r)?"&":"?")+(s+"="+p);u[p]=a;m.type="text/javascript";m.src=r;m.async=!0;"undefined"!==typeof m.onreadystatechange&&!y&&(m.event="onclick",m.htmlFor=m.id="_reqwest_"+g);m.onload=m.onreadystatechange=function(){if(m[z]&&"complete"!==m[z]&&"loaded"!==m[z]||x)return!1;m.onload=m.onreadystatechange=null;m.onclick&&m.onclick();l.success&&l.success(A);A=void 0;D.removeChild(m);x=1};D.appendChild(m);r={abort:function(){m.onload=m.onreadystatechange=null;l.error&&
l.error({},"Request is aborted: timeout",{});A=void 0;D.removeChild(m);x=1}}}else{s=J();s.open(p,n,!0);p=l.headers||{};p.Accept=p.Accept||B.accept[l.type]||B.accept["*"];!l.crossOrigin&&!p[H]&&(p[H]=B.requestedWith);p[F]||(p[F]=l.contentType||B.contentType);for(r in p)p.hasOwnProperty(r)&&s.setRequestHeader(r,p[r]);"undefined"!==typeof l.withCredentials&&"undefined"!==typeof s.withCredentials&&(s.withCredentials=!!l.withCredentials);var w=this;s.onreadystatechange=function(){if(w._aborted)return e(w.request);
w.request&&4==w.request[z]&&(w.request.onreadystatechange=K,C.test(w.request.status)?q(w.request):e(w.request))};l.before&&l.before(s);s.send(g);r=s}this.request=r}function d(a,c){return new b(a,c)}function e(a){return a?a.replace(/\r?\n/g,"\r\n"):""}function f(a,b){var c=a.name,d=a.tagName.toLowerCase(),h=function(a){a&&!a.disabled&&b(c,e(a.attributes.value&&a.attributes.value.specified?a.value:a.text))},k;if(!a.disabled&&c)switch(d){case "input":/reset|button|image|file/i.test(a.type)||(h=/checkbox/i.test(a.type),
d=/radio/i.test(a.type),k=a.value,(!h&&!d||a.checked)&&b(c,e(h&&""===k?"on":k)));break;case "textarea":b(c,e(a.value));break;case "select":if("select-one"===a.type.toLowerCase())h(0<=a.selectedIndex?a.options[a.selectedIndex]:null);else for(d=0;a.length&&d<a.length;d++)a.options[d].selected&&h(a.options[d])}}function y(){var a,b;for(b=0;b<arguments.length;b++){a=arguments[b];/input|select|textarea/i.test(a.tagName)&&f(a,this);for(var c=["input","select","textarea"],d=void 0,e=void 0,g=void 0,d=0;d<
c.length;d++){g=a[E](c[d]);for(e=0;e<g.length;e++)f(g[e],this)}}}function t(){return d.toQueryString(d.serializeArray.apply(null,arguments))}function n(){var a={};y.apply(function(b,c){b in a?(a[b]&&!x(a[b])&&(a[b]=[a[b]]),a[b].push(c)):a[b]=c},arguments);return a}function q(a,b,c,d){var e,f,g=/\[\]$/;if(x(b))for(e=0;b&&e<b.length;e++)f=b[e],c||g.test(a)?d(a,f):q(a+"["+("object"===typeof f?e:"")+"]",f,c,d);else if("[object Object]"===b.toString())for(e in b)q(a+"["+e+"]",b[e],c,d);else d(a,b)}var u=
window,v=document,C=/^20\d$/,E="getElementsByTagName",z="readyState",F="Content-Type",H="X-Requested-With",D=v[E]("head")[0],I=0,L="reqwest_"+ +new Date,A,K=function(){},x="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},B={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},J=u.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},G={dataFilter:function(a){return a}};b.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){c.call(this,this.o,this.fn)},then:function(a,b){this._fulfilled?a(this._responseArgs.resp):this._erred?b(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(a),this._errorHandlers.push(b));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};d.serializeArray=function(){var a=[];y.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};d.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?n:"array"==a?d.serializeArray:t).apply(null,b)};d.toQueryString=function(a,b){var c,d=b||!1,e=[],f=encodeURIComponent,g=function(a,b){b="function"===typeof b?b():null==b?"":b;e[e.length]=f(a)+"="+f(b)};if(x(a))for(c=0;a&&c<a.length;c++)g(a[c].name,a[c].value);else for(c in a)q(c,a[c],d,g);return e.join("&").replace(/%20/g,"+")};d.getcallbackPrefix=function(){return L};d.compat=function(a,c){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new b(a,c)};d.ajaxSetup=function(a){a=a||{};for(var b in a)G[b]=a[b]};return d};"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):this.reqwest=a();!0};e.lib__reqwest=function(){null===a&&(a=C());return a};window.modules=e})();
(function(){var e=window.modules||[];window.require=function(a){a=a.replace(/\//g,"__");-1===a.indexOf("__")&&(a="__"+a);return null===e[a]?null:e[a]()}})();

