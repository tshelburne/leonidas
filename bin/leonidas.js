(function(){var e=window.modules||[],a=null;e.leonidas__client=function(){null===a&&(a=function(a,f,j,c){this.id=a;this.appName=f;this.state=null!=j?j:{};null==c&&(c=null);if(null==this.id)throw Error("Client Id is required");if(null==this.appName)throw Error("App Name is required");this.lastUpdate=null!=c?c:new Date(0)});return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commander=function(){if(null===a){var e,f,j,c;e=require("leonidas/commands/command");f=require("leonidas/commands/organizer");j=require("leonidas/commands/processor");c=require("leonidas/commands/synchronizer");var b=function(c,b,h,a){this.client=c;this.organizer=b;this.processor=h;this.synchronizer=a};b.create=function(d,b,h){var a;a=new f;b=new j(b);h=new c(h,d,a,b);return new this(d,a,b,h)};b.prototype.startSync=function(c,b){null==c&&(c=
1E3);null==b&&(b=5E3);this.pushInterval=setInterval(this.synchronizer.push,c);return this.pullInterval=setInterval(this.synchronizer.pull,b)};b.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};b.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};b.prototype.issueCommand=function(c,b){var h;h=new e(c,b,this.client.id);this.organizer.local.addCommand(h);return this.processor.runCommand(h)};a=b}return a};window.modules=
e})();(function(){var e=window.modules||[],a=null;e.leonidas__commands__command=function(){if(null===a){var e=function(a,j,c,b,d){this.name=a;this.data=j;this.clientId=c;null==b&&(b=null);this.id=null!=d?d:null;this.timestamp=null!=b?b:new Date};e.prototype.toHash=function(){return{id:this.id,name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};a=e}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__command_list=function(){if(null===a){var e=[].indexOf||function(c){for(var b=0,d=this.length;b<d;b++)if(b in this&&this[b]===c)return b;return-1},f=function(){this.commands=[]},j;f.prototype.addCommand=function(c){null==c.id&&(c.id=j(this.commands));return this.commands.push(c)};f.prototype.addCommands=function(c){var b,d,g,h;h=[];d=0;for(g=c.length;d<g;d++)b=c[d],h.push(this.addCommand(b));return h};f.prototype.commandsThrough=function(c){var b,
d,g,h,a;h=this.commands;a=[];d=0;for(g=h.length;d<g;d++)b=h[d],b.timestamp<=c&&a.push(b);return a};f.prototype.commandsSince=function(c){var b,d,g,a,f;a=this.commands;f=[];d=0;for(g=a.length;d<g;d++)b=a[d],b.timestamp>c&&f.push(b);return f};j=function(c){b;for(var b,d;0<=e.call(function(){var b,a,f;f=[];b=0;for(a=c.length;b<a;b++)d=c[b],f.push(d.id);return f}(),b);)b=""+(new Date).getTime()+"-"+c.length;return b};a=f}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__handler=function(){if(null===a){var e=function(){};e.prototype.handles=function(a){return a.name===this.name};e.prototype.run=function(){throw Error("Every CommandHandler should override #run.");};e.prototype.rollback=function(){throw Error("Every CommandHandler should override #rollback.");};a=e}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__organizer=function(){if(null===a){var e;e=require("leonidas/commands/command_list");var f=function(){this.local=new e;this.external=new e};f.prototype.commandsThrough=function(a){var c,b,d,g,h;g=this.allCommands();h=[];b=0;for(d=g.length;b<d;b++)c=g[b],c.timestamp<=a&&h.push(c);return h};f.prototype.commandsSince=function(a){var c,b,d,g,h;g=this.allCommands();h=[];b=0;for(d=g.length;b<d;b++)c=g[b],c.timestamp>a&&h.push(c);return h};
f.prototype.allCommands=function(){var a,c,b,d,g;d=this.local.commands;g=[];c=0;for(b=d.length;c<b;c++)a=d[c],g.push(a);d=this.external.commands;c=0;for(b=d.length;c<b;c++)a=d[c],g.push(a);return g};f.prototype.commandsFor=function(a,c){var b,d,g,h,f;null==c&&(c=null);null==c&&(c=new Date(0));h=this.commandsSince(c);f=[];d=0;for(g=h.length;d<g;d++)b=h[d],b.clientId===a&&f.push(b);return f};a=f}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__processor=function(){if(null===a){var e=function(a){this.handlers=a};e.prototype.runCommand=function(a){var e,c,b,d,g;d=this.handlers;g=[];c=0;for(b=d.length;c<b;c++)e=d[c],e.handles(a)?g.push(e.run(a)):g.push(void 0);return g};e.prototype.runCommands=function(a){var e,c,b,d;a.sort(function(c,b){return c.timestamp>b.timestamp?1:-1});d=[];c=0;for(b=a.length;c<b;c++)e=a[c],d.push(this.runCommand(e));return d};e.prototype.rollbackCommand=
function(a){var e,c,b,d,g;d=this.handlers;g=[];c=0;for(b=d.length;c<b;c++)e=d[c],e.handles(a)?g.push(e.rollback(a)):g.push(void 0);return g};e.prototype.rollbackCommands=function(a){var e,c,b,d;a.sort(function(c,b){return c.timestamp<b.timestamp?1:-1});d=[];c=0;for(b=a.length;c<b;c++)e=a[c],d.push(this.rollbackCommand(e));return d};a=e}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null;e.leonidas__commands__synchronizer=function(){if(null===a){var e,f=function(c,b){return function(){return c.apply(b,arguments)}};require("lib/reqwest");e=require("leonidas/commands/command");var j=function(c,b,d,a){this.syncUrl=c;this.client=b;this.organizer=d;this.processor=a;this.reconcile=f(this.reconcile,this);this.pull=f(this.pull,this);this.push=f(this.push,this);this.stableTimestamp=new Date(0);this.externalClients=[]};j.prototype.push=function(){var c,
b=this,a,e,h,f;h=this.organizer.local.commandsSince(this.client.lastUpdate);f=[];a=0;for(e=h.length;a<e;a++)c=h[a],f.push(c);if(0!==f.length){a=reqwest;e=""+this.syncUrl;h=this.client.appName;var j=this.client.id,n=this.externalClients,r,s,v;v=[];r=0;for(s=f.length;r<s;r++)c=f[r],v.push(c.toHash());return a({url:e,type:"json",method:"post",data:{appName:h,clientId:j,clients:n,commands:v},error:function(){return console.log("push error")},success:function(a){if(a.success)return a=Math.max.apply(b,
function(){var b,a,d;d=[];b=0;for(a=f.length;b<a;b++)c=f[b],d.push(c.timestamp);return d}()),b.client.lastUpdate=new Date(a);if("reconcile required"===a.message&&null==b.reconcileTimeout)return b.reconcileTimeout=setTimeout(b.reconcile,1E3)}})}};j.prototype.pull=function(){var c=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{appName:this.client.appName,clientId:this.client.id,clients:this.externalClients},error:function(){return console.log("pull error")},success:function(b){var a;
if(b.success){var g,h,f,j;f=b.data.commands;j=[];g=0;for(h=f.length;g<h;g++)a=f[g],j.push(new e(a.name,a.data,a.connection,new Date(a.timestamp),a.id));c.processor.rollbackCommands(c.organizer.commandsSince(c.stableTimestamp));c.organizer.external.addCommands(j);c.processor.runCommands(c.organizer.commandsSince(c.stableTimestamp));c.externalClients=b.data.currentClients;return c.stableTimestamp=b.data.stableTimestamp}if("reconcile required"===b.message&&null==c.reconcileTimeout)return c.reconcileTimeout=
setTimeout(c.reconcile,1E3)}})};j.prototype.reconcile=function(){var a,b,d,e,f,j,u=this;b={};d=this.client.id;var n;j=this.organizer.local.commands;n=[];e=0;for(f=j.length;e<f;e++)a=j[e],n.push(a.toHash());b[d]=n;j=this.externalClients;e=0;for(f=j.length;e<f;e++){a=j[e];d=this.organizer.commandsFor(a.id);n=b;for(var r=""+a.id,s=void 0,v=void 0,y=void 0,y=[],s=0,v=d.length;s<v;s++)a=d[s],y.push(a.toHash());n[r]=y}return reqwest({url:""+this.syncUrl+"/reconcile",type:"json",method:"post",data:{appName:this.client.appName,
clientId:this.client.id,clients:this.externalClients,commandList:b,stableTimestamp:this.stableTimestamp},error:function(){return console.log("reconcile error")},success:function(a){if(a.success)return clearInterval(u.reconcileTimeout),u.reconcileTimeout=null;if("reconcile required"===a.message)return u.reconcileTimeout=setTimeout(u.reconcile,1E3)}})};a=j}return a};window.modules=e})();
(function(){var e=window.modules||[],a=null,D=function(){var a=function(){function a(k){B=k}function c(a,c){this.o=a;this.fn=c;b.apply(this,arguments)}function b(k,b){function c(a){k.timeout&&clearTimeout(f.timeout);for(f.timeout=null;0<f._completeHandlers.length;)f._completeHandlers.shift()(a)}function e(a,b,k){f._responseArgs.resp=a;f._responseArgs.msg=b;f._responseArgs.t=k;for(f._erred=!0;0<f._errorHandlers.length;)f._errorHandlers.shift()(a,b,k);c(a)}this.url="string"==typeof k?k:k.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var f=this,g;if(!(g=k.type))g=(g=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?g[1]:"js";var h=g;b=b||function(){};k.timeout&&(this.timeout=setTimeout(function(){f.abort()},k.timeout));k.success&&this._fulfillmentHandlers.push(function(){k.success.apply(k,arguments)});k.error&&this._errorHandlers.push(function(){k.error.apply(k,arguments)});k.complete&&this._completeHandlers.push(function(){k.complete.apply(k,
arguments)});var q;var r=function(a){var k=H.dataFilter(a.responseText,h);if(k=a.responseText=k)switch(h){case "json":try{a=s.JSON?s.JSON.parse(k):eval("("+k+")")}catch(d){return e(a,"Could not parse JSON in response",d)}break;case "js":a=eval(k);break;case "html":a=k;break;case "xml":a=a.responseXML&&a.responseXML.parseError&&a.responseXML.parseError.errorCode&&a.responseXML.parseError.reason?null:a.responseXML}f._responseArgs.resp=a;f._fulfilled=!0;for(b(a);0<f._fulfillmentHandlers.length;)f._fulfillmentHandlers.shift()(a);
c(a)},l=this.o,p=(l.method||"GET").toUpperCase(),n="string"===typeof l?l:l.url;g=!1!==l.processData&&l.data&&"string"!==typeof l.data?d.toQueryString(l.data):l.data||null;var t;if(("jsonp"==l.type||"GET"==p)&&g)n=n+(/\?/.test(n)?"&":"?")+g,g=null;if("jsonp"==l.type){q=n;g=D++;t=l.jsonpCallback||"callback";var p=l.jsonpCallbackName||d.getcallbackPrefix(g),n=RegExp("((^|\\?|&)"+t+")=([^&]+)"),u=q.match(n),m=v.createElement("script"),x=0,z=-1!==navigator.userAgent.indexOf("MSIE 10.0");u?"?"===u[3]?q=
q.replace(n,"$1="+p):p=u[3]:q=q+(/\?/.test(q)?"&":"?")+(t+"="+p);s[p]=a;m.type="text/javascript";m.src=q;m.async=!0;"undefined"!==typeof m.onreadystatechange&&!z&&(m.event="onclick",m.htmlFor=m.id="_reqwest_"+g);m.onload=m.onreadystatechange=function(){if(m[A]&&"complete"!==m[A]&&"loaded"!==m[A]||x)return!1;m.onload=m.onreadystatechange=null;m.onclick&&m.onclick();l.success&&l.success(B);B=void 0;E.removeChild(m);x=1};E.appendChild(m);q={abort:function(){m.onload=m.onreadystatechange=null;l.error&&
l.error({},"Request is aborted: timeout",{});B=void 0;E.removeChild(m);x=1}}}else{t=J();t.open(p,n,!0);p=l.headers||{};p.Accept=p.Accept||C.accept[l.type]||C.accept["*"];!l.crossOrigin&&!p[I]&&(p[I]=C.requestedWith);p[G]||(p[G]=l.contentType||C.contentType);for(q in p)p.hasOwnProperty(q)&&t.setRequestHeader(q,p[q]);"undefined"!==typeof l.withCredentials&&"undefined"!==typeof t.withCredentials&&(t.withCredentials=!!l.withCredentials);var w=this;t.onreadystatechange=function(){if(w._aborted)return e(w.request);
w.request&&4==w.request[A]&&(w.request.onreadystatechange=K,y.test(w.request.status)?r(w.request):e(w.request))};l.before&&l.before(t);t.send(g);q=t}this.request=q}function d(a,b){return new c(a,b)}function e(a){return a?a.replace(/\r?\n/g,"\r\n"):""}function f(a,b){var c=a.name,d=a.tagName.toLowerCase(),h=function(a){a&&!a.disabled&&b(c,e(a.attributes.value&&a.attributes.value.specified?a.value:a.text))},j;if(!a.disabled&&c)switch(d){case "input":/reset|button|image|file/i.test(a.type)||(h=/checkbox/i.test(a.type),
d=/radio/i.test(a.type),j=a.value,(!h&&!d||a.checked)&&b(c,e(h&&""===j?"on":j)));break;case "textarea":b(c,e(a.value));break;case "select":if("select-one"===a.type.toLowerCase())h(0<=a.selectedIndex?a.options[a.selectedIndex]:null);else for(d=0;a.length&&d<a.length;d++)a.options[d].selected&&h(a.options[d])}}function z(){var a,b;for(b=0;b<arguments.length;b++){a=arguments[b];/input|select|textarea/i.test(a.tagName)&&f(a,this);for(var c=["input","select","textarea"],d=void 0,e=void 0,g=void 0,d=0;d<
c.length;d++){g=a[F](c[d]);for(e=0;e<g.length;e++)f(g[e],this)}}}function u(){return d.toQueryString(d.serializeArray.apply(null,arguments))}function n(){var a={};z.apply(function(b,c){b in a?(a[b]&&!x(a[b])&&(a[b]=[a[b]]),a[b].push(c)):a[b]=c},arguments);return a}function r(a,b,c,d){var e,f,g=/\[\]$/;if(x(b))for(e=0;b&&e<b.length;e++)f=b[e],c||g.test(a)?d(a,f):r(a+"["+("object"===typeof f?e:"")+"]",f,c,d);else if("[object Object]"===b.toString())for(e in b)r(a+"["+e+"]",b[e],c,d);else d(a,b)}var s=
window,v=document,y=/^20\d$/,F="getElementsByTagName",A="readyState",G="Content-Type",I="X-Requested-With",E=v[F]("head")[0],D=0,L="reqwest_"+ +new Date,B,K=function(){},x="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},C={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},J=s.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},H={dataFilter:function(a){return a}};c.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){b.call(this,this.o,this.fn)},then:function(a,b){this._fulfilled?a(this._responseArgs.resp):this._erred?b(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(a),this._errorHandlers.push(b));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};d.serializeArray=function(){var a=[];z.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};d.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?n:"array"==a?d.serializeArray:u).apply(null,b)};d.toQueryString=function(a,b){var c,e=b||!1,d=[],f=encodeURIComponent,g=function(a,b){b="function"===typeof b?b():null==b?"":b;d[d.length]=f(a)+"="+f(b)};if(x(a))for(c=0;a&&c<a.length;c++)g(a[c].name,a[c].value);else for(c in a)r(c,a[c],e,g);return d.join("&").replace(/%20/g,"+")};d.getcallbackPrefix=function(){return L};d.compat=function(a,b){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new c(a,b)};d.ajaxSetup=function(a){a=a||{};for(var b in a)H[b]=a[b]};return d};"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):this.reqwest=a();!0};e.lib__reqwest=function(){null===a&&(a=D());return a};window.modules=e})();
(function(){var e=window.modules||[];window.require=function(a){a=a.replace(/\//g,"__");-1===a.indexOf("__")&&(a="__"+a);return null===e[a]?null:e[a]()}})();

