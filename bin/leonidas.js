(function(){var b=window.modules||[],a=null;b.leonidas__client=function(){if(null===a){var b=function(a,h){this.id=a;this.lockedState=h;this.activeState={};this.copyState(this.activeState,this.lockedState)};b.prototype.revertState=function(){return this.copyState(this.activeState,this.lockedState)};b.prototype.lockState=function(){return this.copyState(this.lockedState,this.activeState)};b.prototype.copyState=function(a,h){var e,f,c;for(e in a)delete a[e];c=[];for(e in h)f=h[e],c.push(a[e]=f);return c};
a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commander=function(){if(null===a){var b,g,h,e,f;b=require("leonidas/commands/command");g=require("leonidas/commands/organizer");h=require("leonidas/commands/processor");e=require("leonidas/commands/stabilizer");f=require("leonidas/commands/synchronizer");var c=function(e,c,f,h,a){this.client=e;this.organizer=c;this.processor=f;this.stabilizer=h;this.synchronizer=a};c.create=function(c,a,b){var m,s;m=new g;a=new h(a);s=new e(c,m,a);b=new f(b,
c,m,s);return new this(c,m,a,s,b)};c.prototype.startSync=function(e,c){null==e&&(e=1E3);null==c&&(c=5E3);this.pushInterval=setInterval(this.synchronizer.push,e);return this.pullInterval=setInterval(this.synchronizer.pull,c)};c.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};c.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};c.prototype.issueCommand=function(e,c){var f;f=new b(e,c,this.client.id);this.organizer.addCommand(f);
return this.processor.processCommand(f)};a=c}return a};window.modules=b})();(function(){var b=window.modules||[],a=null;b.leonidas__commands__command=function(){if(null===a){var b=function(a,h,e,f){this.name=a;this.data=h;this.clientId=e;null==f&&(f=null);this.timestamp=null!=f?f:new Date};b.prototype.toHash=function(){return{name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__organizer=function(){if(null===a){var b=[].indexOf||function(a){for(var e=0,f=this.length;e<f;e++)if(e in this&&this[e]===a)return e;return-1},g=function(){this.unsyncedCommands=[];this.syncedCommands=[];this.lockedCommands=[]};g.prototype.addCommand=function(a,e){null==e&&(e=!0);return e?this.unsyncedCommands.push(a):this.syncedCommands.push(a)};g.prototype.addCommands=function(a,e){var f,c,b,g;null==e&&(e=!0);g=[];c=0;for(b=a.length;c<
b;c++)f=a[c],g.push(this.addCommand(f,e));return g};g.prototype.markAsSynced=function(a){var e,f,c;f=0;for(c=a.length;f<c;f++)e=a[f],0>b.call(this.syncedCommands,e)&&this.syncedCommands.push(e);var k,g;k=this.unsyncedCommands;g=[];f=0;for(c=k.length;f<c;f++)e=k[f],0>b.call(a,e)&&g.push(e);return this.unsyncedCommands=g};g.prototype.lockCommands=function(a){var e,f,c;f=0;for(c=a.length;f<c;f++)e=a[f],this.lockedCommands.push(e);var g,B;g=this.syncedCommands;B=[];f=0;for(c=g.length;f<c;f++)e=g[f],0>
b.call(a,e)&&B.push(e);return this.syncedCommands=B};g.prototype.activeCommands=function(){return this.unsyncedCommands.concat(this.syncedCommands).sort(function(a,e){return a.timestamp>e.timestamp?1:-1})};a=g}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__processor=function(){if(null===a){var b=function(a){this.handlers=a};b.prototype.processCommand=function(a){var b,e,f,c,k;c=this.handlers;k=[];e=0;for(f=c.length;e<f;e++)b=c[e],b.handles(a)?k.push(b.run(a)):k.push(void 0);return k};b.prototype.processCommands=function(a){var b,e,f,c;c=[];e=0;for(f=a.length;e<f;e++)b=a[e],c.push(this.processCommand(b));return c};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__stabilizer=function(){if(null===a){var b=function(a,b,e){this.client=a;this.organizer=b;this.processor=e};b.prototype.stabilize=function(a){var b,e,f,c,k;c=this.organizer.activeCommands();k=[];e=0;for(f=c.length;e<f;e++)b=c[e],b.timestamp<=a&&k.push(b);this.client.revertState();this.processor.processCommands(k);this.client.lockState();this.organizer.lockCommands(k);return this.processor.processCommands(this.organizer.activeCommands())};
a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__synchronizer=function(){if(null===a){var b,g=function(a,b){return function(){return a.apply(b,arguments)}};require("lib/reqwest");b=require("leonidas/commands/command");var h=function(a,b,c,k){this.syncUrl=a;this.client=b;this.organizer=c;this.stabilizer=k;this.pull=g(this.pull,this);this.push=g(this.push,this);this.externalClients=[]};h.prototype.push=function(){var a,b=this,c,k,g,h;g=this.organizer.unsyncedCommands;h=[];c=0;for(k=
g.length;c<k;c++)a=g[c],h.push(a);c=reqwest;k=""+this.syncUrl;g=this.client.id;var r,s,u;u=[];r=0;for(s=h.length;r<s;r++)a=h[r],u.push(a.toHash());return c({url:k,type:"json",method:"post",data:{clientId:g,commands:u},error:function(){return console.log("push error")},success:function(){return b.organizer.markAsSynced(h)}})};h.prototype.pull=function(){var a=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{clientId:this.client.id,clients:this.externalClients},error:function(){return console.log("pull error")},
success:function(f){var c;a.externalClients=f.data.currentClients;var g,h,v,r;v=f.data.commands;r=[];g=0;for(h=v.length;g<h;g++)c=v[g],r.push(new b(c.name,c.data,c.connection,new Date(c.timestamp)));a.organizer.addCommands(r,!1);return a.stabilizer.stabilize(f.data.stableTimestamp)}})};a=h}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null,m=function(){var a=function(){function a(d){x=d}function b(d,a){this.o=d;this.fn=a;f.apply(this,arguments)}function f(d,b){function e(a){d.timeout&&clearTimeout(g.timeout);for(g.timeout=null;0<g._completeHandlers.length;)g._completeHandlers.shift()(a)}function f(d,a,b){g._responseArgs.resp=d;g._responseArgs.msg=a;g._responseArgs.t=b;for(g._erred=!0;0<g._errorHandlers.length;)g._errorHandlers.shift()(d,a,b);e(d)}this.url="string"==typeof d?d:d.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var g=this,q;if(!(q=d.type))q=(q=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?q[1]:"js";var k=q;b=b||function(){};d.timeout&&(this.timeout=setTimeout(function(){g.abort()},d.timeout));d.success&&this._fulfillmentHandlers.push(function(){d.success.apply(d,arguments)});d.error&&this._errorHandlers.push(function(){d.error.apply(d,arguments)});d.complete&&this._completeHandlers.push(function(){d.complete.apply(d,
arguments)});var p;var r=function(d){var a=E.dataFilter(d.responseText,k);if(a=d.responseText=a)switch(k){case "json":try{d=y.JSON?y.JSON.parse(a):eval("("+a+")")}catch(c){return f(d,"Could not parse JSON in response",c)}break;case "js":d=eval(a);break;case "html":d=a;break;case "xml":d=d.responseXML&&d.responseXML.parseError&&d.responseXML.parseError.errorCode&&d.responseXML.parseError.reason?null:d.responseXML}g._responseArgs.resp=d;g._fulfilled=!0;for(b(d);0<g._fulfillmentHandlers.length;)g._fulfillmentHandlers.shift()(d);
e(d)},j=this.o,n=(j.method||"GET").toUpperCase(),m="string"===typeof j?j:j.url;q=!1!==j.processData&&j.data&&"string"!==typeof j.data?c.toQueryString(j.data):j.data||null;var t;if(("jsonp"==j.type||"GET"==n)&&q)m=m+(/\?/.test(m)?"&":"?")+q,q=null;if("jsonp"==j.type){p=m;q=J++;t=j.jsonpCallback||"callback";var n=j.jsonpCallbackName||c.getcallbackPrefix(q),m=RegExp("((^|\\?|&)"+t+")=([^&]+)"),s=p.match(m),l=F.createElement("script"),u=0,v=-1!==navigator.userAgent.indexOf("MSIE 10.0");s?"?"===s[3]?p=
p.replace(m,"$1="+n):n=s[3]:p=p+(/\?/.test(p)?"&":"?")+(t+"="+n);y[n]=a;l.type="text/javascript";l.src=p;l.async=!0;"undefined"!==typeof l.onreadystatechange&&!v&&(l.event="onclick",l.htmlFor=l.id="_reqwest_"+q);l.onload=l.onreadystatechange=function(){if(l[z]&&"complete"!==l[z]&&"loaded"!==l[z]||u)return!1;l.onload=l.onreadystatechange=null;l.onclick&&l.onclick();j.success&&j.success(x);x=void 0;C.removeChild(l);u=1};C.appendChild(l);p={abort:function(){l.onload=l.onreadystatechange=null;j.error&&
j.error({},"Request is aborted: timeout",{});x=void 0;C.removeChild(l);u=1}}}else{t=K();t.open(n,m,!0);n=j.headers||{};n.Accept=n.Accept||A.accept[j.type]||A.accept["*"];!j.crossOrigin&&!n[G]&&(n[G]=A.requestedWith);n[H]||(n[H]=j.contentType||A.contentType);for(p in n)n.hasOwnProperty(p)&&t.setRequestHeader(p,n[p]);"undefined"!==typeof j.withCredentials&&"undefined"!==typeof t.withCredentials&&(t.withCredentials=!!j.withCredentials);var w=this;t.onreadystatechange=function(){if(w._aborted)return f(w.request);
w.request&&4==w.request[z]&&(w.request.onreadystatechange=L,M.test(w.request.status)?r(w.request):f(w.request))};j.before&&j.before(t);t.send(q);p=t}this.request=p}function c(d,a){return new b(d,a)}function g(d){return d?d.replace(/\r?\n/g,"\r\n"):""}function m(d,a){var b=d.name,c=d.tagName.toLowerCase(),e=function(d){d&&!d.disabled&&a(b,g(d.attributes.value&&d.attributes.value.specified?d.value:d.text))},f;if(!d.disabled&&b)switch(c){case "input":/reset|button|image|file/i.test(d.type)||(e=/checkbox/i.test(d.type),
c=/radio/i.test(d.type),f=d.value,(!e&&!c||d.checked)&&a(b,g(e&&""===f?"on":f)));break;case "textarea":a(b,g(d.value));break;case "select":if("select-one"===d.type.toLowerCase())e(0<=d.selectedIndex?d.options[d.selectedIndex]:null);else for(c=0;d.length&&c<d.length;c++)d.options[c].selected&&e(d.options[c])}}function v(){var d,a;for(a=0;a<arguments.length;a++){d=arguments[a];/input|select|textarea/i.test(d.tagName)&&m(d,this);for(var b=["input","select","textarea"],c=void 0,e=void 0,f=void 0,c=0;c<
b.length;c++){f=d[I](b[c]);for(e=0;e<f.length;e++)m(f[e],this)}}}function r(){return c.toQueryString(c.serializeArray.apply(null,arguments))}function s(){var d={};v.apply(function(a,b){a in d?(d[a]&&!D(d[a])&&(d[a]=[d[a]]),d[a].push(b)):d[a]=b},arguments);return d}function u(d,a,b,c){var e,f,g=/\[\]$/;if(D(a))for(e=0;a&&e<a.length;e++)f=a[e],b||g.test(d)?c(d,f):u(d+"["+("object"===typeof f?e:"")+"]",f,b,c);else if("[object Object]"===a.toString())for(e in a)u(d+"["+e+"]",a[e],b,c);else c(d,a)}var y=
window,F=document,M=/^20\d$/,I="getElementsByTagName",z="readyState",H="Content-Type",G="X-Requested-With",C=F[I]("head")[0],J=0,N="reqwest_"+ +new Date,x,L=function(){},D="function"==typeof Array.isArray?Array.isArray:function(d){return d instanceof Array},A={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},K=y.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},E={dataFilter:function(d){return d}};b.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){f.call(this,this.o,this.fn)},then:function(d,a){this._fulfilled?d(this._responseArgs.resp):this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(d),this._errorHandlers.push(a));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};c.serializeArray=function(){var a=[];v.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};c.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?s:"array"==a?c.serializeArray:r).apply(null,b)};c.toQueryString=function(a,b){var c,e=b||!1,f=[],g=encodeURIComponent,h=function(a,d){d="function"===typeof d?d():null==d?"":d;f[f.length]=g(a)+"="+g(d)};if(D(a))for(c=0;a&&c<a.length;c++)h(a[c].name,a[c].value);else for(c in a)u(c,a[c],e,h);return f.join("&").replace(/%20/g,"+")};c.getcallbackPrefix=function(){return N};c.compat=function(a,c){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new b(a,c)};c.ajaxSetup=function(a){a=a||{};for(var b in a)E[b]=a[b]};return c};"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):this.reqwest=a();!0};b.lib__reqwest=function(){null===a&&(a=m());return a};window.modules=b})();
(function(){var b=window.modules||[];window.require=function(a){a=a.replace(/\//g,"__");-1===a.indexOf("__")&&(a="__"+a);return null===b[a]?null:b[a]()}})();

