(function(){var b=window.modules||[],a=null;b.leonidas__client=function(){if(null===a){var g=function(a,j){this.id=a;this.lockedState=j;this.activeState={};this.copyState(this.activeState,this.lockedState)};g.prototype.revertState=function(){return this.copyState(this.activeState,this.lockedState)};g.prototype.lockState=function(){return this.copyState(this.lockedState,this.activeState)};g.prototype.copyState=function(a,j){var e,f,c;for(e in a)delete a[e];c=[];for(e in j)f=j[e],c.push(a[e]=f);return c};
a=g}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commander=function(){if(null===a){var g,h,j,e,f;g=require("leonidas/commands/command");h=require("leonidas/commands/organizer");j=require("leonidas/commands/processor");e=require("leonidas/commands/stabilizer");f=require("leonidas/commands/synchronizer");var c=function(e,c,f,a,j){this.client=e;this.organizer=c;this.processor=f;this.stabilizer=a;this.synchronizer=j};c.create=function(c,a,g){var b,q;b=new h;a=new j(a);q=new e(c,b,a);g=new f(g,
c,b,q);return new this(c,b,a,q,g)};c.prototype.startSync=function(e,c){null==e&&(e=1E3);null==c&&(c=5E3);this.pushInterval=setInterval(this.synchronizer.push,e);return this.pullInterval=setInterval(this.synchronizer.pull,c)};c.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};c.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};c.prototype.issueCommand=function(e,c){var f;f=new g(e,c,this.client.id);this.organizer.addCommand(f);
return this.processor.processCommand(f)};a=c}return a};window.modules=b})();(function(){var b=window.modules||[],a=null;b.leonidas__commands__command=function(){if(null===a){var g=function(a,j,e,f){this.name=a;this.data=j;this.clientId=e;null==f&&(f=null);this.timestamp=null!=f?f:new Date};g.prototype.toHash=function(){return{name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};a=g}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__handler=function(){if(null===a){var g=function(){};g.prototype.handles=function(a){return a.name===this.name};g.prototype.run=function(){throw Error("Every CommandHandler should override #run.");};g.prototype.rollback=function(){throw Error("Every CommandHandler should override #rollback.");};a=g}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__organizer=function(){if(null===a){var g=[].indexOf||function(a){for(var e=0,f=this.length;e<f;e++)if(e in this&&this[e]===a)return e;return-1},b=function(){this.unsyncedCommands=[];this.syncedCommands=[];this.lockedCommands=[]};b.prototype.addCommand=function(a,e){null==e&&(e=!0);return e?this.unsyncedCommands.push(a):this.syncedCommands.push(a)};b.prototype.addCommands=function(a,e){var f,c,b,g;null==e&&(e=!0);g=[];c=0;for(b=a.length;c<
b;c++)f=a[c],g.push(this.addCommand(f,e));return g};b.prototype.markAsSynced=function(a){var e,f,c;f=0;for(c=a.length;f<c;f++)e=a[f],0>g.call(this.syncedCommands,e)&&this.syncedCommands.push(e);var b,h;b=this.unsyncedCommands;h=[];f=0;for(c=b.length;f<c;f++)e=b[f],0>g.call(a,e)&&h.push(e);return this.unsyncedCommands=h};b.prototype.lockCommands=function(a){var e,f,c;f=0;for(c=a.length;f<c;f++)e=a[f],this.lockedCommands.push(e);var b,h;b=this.syncedCommands;h=[];f=0;for(c=b.length;f<c;f++)e=b[f],0>
g.call(a,e)&&h.push(e);return this.syncedCommands=h};b.prototype.activeCommands=function(){return this.unsyncedCommands.concat(this.syncedCommands).sort(function(a,e){return a.timestamp>e.timestamp?1:-1})};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__processor=function(){if(null===a){var b=function(a){this.handlers=a};b.prototype.processCommand=function(a){var b,e,f,c,g;c=this.handlers;g=[];e=0;for(f=c.length;e<f;e++)b=c[e],b.handles(a)?g.push(b.run(a)):g.push(void 0);return g};b.prototype.processCommands=function(a){var b,e,f,c;c=[];e=0;for(f=a.length;e<f;e++)b=a[e],c.push(this.processCommand(b));return c};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__stabilizer=function(){if(null===a){var b=function(a,b,e){this.client=a;this.organizer=b;this.processor=e};b.prototype.stabilize=function(a){var b,e,f,c,g;c=this.organizer.activeCommands();g=[];e=0;for(f=c.length;e<f;e++)b=c[e],b.timestamp<=a&&g.push(b);this.client.revertState();this.processor.processCommands(g);this.client.lockState();this.organizer.lockCommands(g);return this.processor.processCommands(this.organizer.activeCommands())};
a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__synchronizer=function(){if(null===a){var b,h=function(a,b){return function(){return a.apply(b,arguments)}};require("lib/reqwest");b=require("leonidas/commands/command");var j=function(a,b,c,g){this.syncUrl=a;this.client=b;this.organizer=c;this.stabilizer=g;this.pull=h(this.pull,this);this.push=h(this.push,this);this.stableTimestamp=0;this.externalClients=[]};j.prototype.push=function(){var a,b=this,c,g,h,j;h=this.organizer.unsyncedCommands;
j=[];c=0;for(g=h.length;c<g;c++)a=h[c],j.push(a);c=reqwest;g=""+this.syncUrl;h=this.client.id;var x=this.externalClients,q,t,u;u=[];q=0;for(t=j.length;q<t;q++)a=j[q],u.push(a.toHash());return c({url:g,type:"json",method:"post",data:{clientId:h,clients:x,commands:u},error:function(){return console.log("push error")},success:function(){return b.organizer.markAsSynced(j)}})};j.prototype.pull=function(){var a=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{clientId:this.client.id,
clients:this.externalClients},error:function(){return console.log("pull error")},success:function(f){a.externalClients=f.data.currentClients;a.stableTimestamp=f.data.stableTimestamp;var c,h,j,s;j=f.data.commands;s=[];c=0;for(h=j.length;c<h;c++)f=j[c],s.push(new b(f.name,f.data,f.connection,new Date(f.timestamp)));a.organizer.addCommands(s,!1);return a.stabilizer.stabilize(a.stableTimestamp)}})};a=j}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null,g=function(){var a=function(){function a(d){y=d}function b(d,a){this.o=d;this.fn=a;f.apply(this,arguments)}function f(d,b){function e(a){d.timeout&&clearTimeout(g.timeout);for(g.timeout=null;0<g._completeHandlers.length;)g._completeHandlers.shift()(a)}function f(d,a,b){g._responseArgs.resp=d;g._responseArgs.msg=a;g._responseArgs.t=b;for(g._erred=!0;0<g._errorHandlers.length;)g._errorHandlers.shift()(d,a,b);e(d)}this.url="string"==typeof d?d:d.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var g=this,p;if(!(p=d.type))p=(p=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?p[1]:"js";var h=p;b=b||function(){};d.timeout&&(this.timeout=setTimeout(function(){g.abort()},d.timeout));d.success&&this._fulfillmentHandlers.push(function(){d.success.apply(d,arguments)});d.error&&this._errorHandlers.push(function(){d.error.apply(d,arguments)});d.complete&&this._completeHandlers.push(function(){d.complete.apply(d,
arguments)});var n;var q=function(d){var a=D.dataFilter(d.responseText,h);if(a=d.responseText=a)switch(h){case "json":try{d=u.JSON?u.JSON.parse(a):eval("("+a+")")}catch(c){return f(d,"Could not parse JSON in response",c)}break;case "js":d=eval(a);break;case "html":d=a;break;case "xml":d=d.responseXML&&d.responseXML.parseError&&d.responseXML.parseError.errorCode&&d.responseXML.parseError.reason?null:d.responseXML}g._responseArgs.resp=d;g._fulfilled=!0;for(b(d);0<g._fulfillmentHandlers.length;)g._fulfillmentHandlers.shift()(d);
e(d)},k=this.o,m=(k.method||"GET").toUpperCase(),v="string"===typeof k?k:k.url;p=!1!==k.processData&&k.data&&"string"!==typeof k.data?c.toQueryString(k.data):k.data||null;var r;if(("jsonp"==k.type||"GET"==m)&&p)v=v+(/\?/.test(v)?"&":"?")+p,p=null;if("jsonp"==k.type){n=v;p=I++;r=k.jsonpCallback||"callback";var m=k.jsonpCallbackName||c.getcallbackPrefix(p),v=RegExp("((^|\\?|&)"+r+")=([^&]+)"),s=n.match(v),l=E.createElement("script"),t=0,x=-1!==navigator.userAgent.indexOf("MSIE 10.0");s?"?"===s[3]?n=
n.replace(v,"$1="+m):m=s[3]:n=n+(/\?/.test(n)?"&":"?")+(r+"="+m);u[m]=a;l.type="text/javascript";l.src=n;l.async=!0;"undefined"!==typeof l.onreadystatechange&&!x&&(l.event="onclick",l.htmlFor=l.id="_reqwest_"+p);l.onload=l.onreadystatechange=function(){if(l[z]&&"complete"!==l[z]&&"loaded"!==l[z]||t)return!1;l.onload=l.onreadystatechange=null;l.onclick&&l.onclick();k.success&&k.success(y);y=void 0;B.removeChild(l);t=1};B.appendChild(l);n={abort:function(){l.onload=l.onreadystatechange=null;k.error&&
k.error({},"Request is aborted: timeout",{});y=void 0;B.removeChild(l);t=1}}}else{r=J();r.open(m,v,!0);m=k.headers||{};m.Accept=m.Accept||A.accept[k.type]||A.accept["*"];!k.crossOrigin&&!m[F]&&(m[F]=A.requestedWith);m[G]||(m[G]=k.contentType||A.contentType);for(n in m)m.hasOwnProperty(n)&&r.setRequestHeader(n,m[n]);"undefined"!==typeof k.withCredentials&&"undefined"!==typeof r.withCredentials&&(r.withCredentials=!!k.withCredentials);var w=this;r.onreadystatechange=function(){if(w._aborted)return f(w.request);
w.request&&4==w.request[z]&&(w.request.onreadystatechange=K,L.test(w.request.status)?q(w.request):f(w.request))};k.before&&k.before(r);r.send(p);n=r}this.request=n}function c(d,a){return new b(d,a)}function g(d){return d?d.replace(/\r?\n/g,"\r\n"):""}function h(d,a){var b=d.name,c=d.tagName.toLowerCase(),e=function(d){d&&!d.disabled&&a(b,g(d.attributes.value&&d.attributes.value.specified?d.value:d.text))},f;if(!d.disabled&&b)switch(c){case "input":/reset|button|image|file/i.test(d.type)||(e=/checkbox/i.test(d.type),
c=/radio/i.test(d.type),f=d.value,(!e&&!c||d.checked)&&a(b,g(e&&""===f?"on":f)));break;case "textarea":a(b,g(d.value));break;case "select":if("select-one"===d.type.toLowerCase())e(0<=d.selectedIndex?d.options[d.selectedIndex]:null);else for(c=0;d.length&&c<d.length;c++)d.options[c].selected&&e(d.options[c])}}function s(){var d,a;for(a=0;a<arguments.length;a++){d=arguments[a];/input|select|textarea/i.test(d.tagName)&&h(d,this);for(var b=["input","select","textarea"],c=void 0,e=void 0,f=void 0,c=0;c<
b.length;c++){f=d[H](b[c]);for(e=0;e<f.length;e++)h(f[e],this)}}}function x(){return c.toQueryString(c.serializeArray.apply(null,arguments))}function q(){var d={};s.apply(function(a,b){a in d?(d[a]&&!C(d[a])&&(d[a]=[d[a]]),d[a].push(b)):d[a]=b},arguments);return d}function t(d,a,b,c){var e,f,g=/\[\]$/;if(C(a))for(e=0;a&&e<a.length;e++)f=a[e],b||g.test(d)?c(d,f):t(d+"["+("object"===typeof f?e:"")+"]",f,b,c);else if("[object Object]"===a.toString())for(e in a)t(d+"["+e+"]",a[e],b,c);else c(d,a)}var u=
window,E=document,L=/^20\d$/,H="getElementsByTagName",z="readyState",G="Content-Type",F="X-Requested-With",B=E[H]("head")[0],I=0,M="reqwest_"+ +new Date,y,K=function(){},C="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},A={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},J=u.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},D={dataFilter:function(a){return a}};b.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){f.call(this,this.o,this.fn)},then:function(a,b){this._fulfilled?a(this._responseArgs.resp):this._erred?b(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(a),this._errorHandlers.push(b));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};c.serializeArray=function(){var a=[];s.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};c.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?q:"array"==a?c.serializeArray:x).apply(null,b)};c.toQueryString=function(a,b){var c,e=b||!1,f=[],g=encodeURIComponent,h=function(a,b){b="function"===typeof b?b():null==b?"":b;f[f.length]=g(a)+"="+g(b)};if(C(a))for(c=0;a&&c<a.length;c++)h(a[c].name,a[c].value);else for(c in a)t(c,a[c],e,h);return f.join("&").replace(/%20/g,"+")};c.getcallbackPrefix=function(){return M};c.compat=function(a,c){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new b(a,c)};c.ajaxSetup=function(a){a=a||{};for(var b in a)D[b]=a[b]};return c};"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):this.reqwest=a();!0};b.lib__reqwest=function(){null===a&&(a=g());return a};window.modules=b})();
(function(){var b=window.modules||[];window.require=function(a){a=a.replace(/\//g,"__");-1===a.indexOf("__")&&(a="__"+a);return null===b[a]?null:b[a]()}})();

