(function(){var b=window.modules||[],a=null;b.leonidas__client=function(){if(null===a){var k=function(a,h){this.id=a;this.lockedState=h;this.activeState={};this.copyState(this.activeState,this.lockedState)};k.prototype.revertState=function(){return this.copyState(this.activeState,this.lockedState)};k.prototype.lockState=function(){return this.copyState(this.lockedState,this.activeState)};k.prototype.copyState=function(a,h){var e,f,c;for(e in a)delete a[e];c=[];for(e in h)f=h[e],c.push(a[e]=f);return c};
a=k}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commander=function(){if(null===a){var k,g,h,e,f;k=require("leonidas/commands/command");g=require("leonidas/commands/organizer");h=require("leonidas/commands/processor");e=require("leonidas/commands/stabilizer");f=require("leonidas/commands/synchronizer");var c=function(e,c,f,a,h){this.client=e;this.organizer=c;this.processor=f;this.stabilizer=a;this.synchronizer=h};c.create=function(c,a,k){var b,s;b=new g;a=new h(a);s=new e(c,b,a);k=new f(k,
c,b,s);return new this(c,b,a,s,k)};c.prototype.startSync=function(e,c){null==e&&(e=1E3);null==c&&(c=5E3);this.pushInterval=setInterval(this.synchronizer.push,e);return this.pullInterval=setInterval(this.synchronizer.pull,c)};c.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};c.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};c.prototype.issueCommand=function(e,c){var f;f=new k(e,c,this.client.id);this.organizer.addCommand(f);
return this.processor.processCommand(f)};a=c}return a};window.modules=b})();(function(){var b=window.modules||[],a=null;b.leonidas__commands__command=function(){if(null===a){var b=function(a,h,e,f){this.name=a;this.data=h;this.clientId=e;null==f&&(f=null);this.timestamp=null!=f?f:new Date};b.prototype.toHash=function(){return{name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__handler=function(){if(null===a){var b=function(){};b.prototype.handles=function(a){return a.name===this.name};b.prototype.run=function(){throw Error("Every CommandHandler should override to process a command #run.");};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__organizer=function(){if(null===a){var b=[].indexOf||function(a){for(var e=0,f=this.length;e<f;e++)if(e in this&&this[e]===a)return e;return-1},g=function(){this.unsyncedCommands=[];this.syncedCommands=[];this.lockedCommands=[]};g.prototype.addCommand=function(a,e){null==e&&(e=!0);return e?this.unsyncedCommands.push(a):this.syncedCommands.push(a)};g.prototype.addCommands=function(a,e){var f,c,b,g;null==e&&(e=!0);g=[];c=0;for(b=a.length;c<
b;c++)f=a[c],g.push(this.addCommand(f,e));return g};g.prototype.markAsSynced=function(a){var e,f,c;f=0;for(c=a.length;f<c;f++)e=a[f],0>b.call(this.syncedCommands,e)&&this.syncedCommands.push(e);var g,n;g=this.unsyncedCommands;n=[];f=0;for(c=g.length;f<c;f++)e=g[f],0>b.call(a,e)&&n.push(e);return this.unsyncedCommands=n};g.prototype.lockCommands=function(a){var e,f,c;f=0;for(c=a.length;f<c;f++)e=a[f],this.lockedCommands.push(e);var g,n;g=this.syncedCommands;n=[];f=0;for(c=g.length;f<c;f++)e=g[f],0>
b.call(a,e)&&n.push(e);return this.syncedCommands=n};g.prototype.activeCommands=function(){return this.unsyncedCommands.concat(this.syncedCommands).sort(function(a,e){return a.timestamp>e.timestamp?1:-1})};a=g}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__processor=function(){if(null===a){var b=function(a){this.handlers=a};b.prototype.processCommand=function(a){var b,e,f,c,m;c=this.handlers;m=[];e=0;for(f=c.length;e<f;e++)b=c[e],b.handles(a)?m.push(b.run(a)):m.push(void 0);return m};b.prototype.processCommands=function(a){var b,e,f,c;c=[];e=0;for(f=a.length;e<f;e++)b=a[e],c.push(this.processCommand(b));return c};a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__stabilizer=function(){if(null===a){var b=function(a,b,e){this.client=a;this.organizer=b;this.processor=e};b.prototype.stabilize=function(a){var b,e,f,c,m;c=this.organizer.activeCommands();m=[];e=0;for(f=c.length;e<f;e++)b=c[e],b.timestamp<=a&&m.push(b);this.client.revertState();this.processor.processCommands(m);this.client.lockState();this.organizer.lockCommands(m);return this.processor.processCommands(this.organizer.activeCommands())};
a=b}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null;b.leonidas__commands__synchronizer=function(){if(null===a){var b,g=function(a,b){return function(){return a.apply(b,arguments)}};require("lib/reqwest");b=require("leonidas/commands/command");var h=function(a,b,c,m){this.syncUrl=a;this.client=b;this.organizer=c;this.stabilizer=m;this.pull=g(this.pull,this);this.push=g(this.push,this);this.stableTimestamp=0;this.externalClients=[]};h.prototype.push=function(){var a,b=this,c,g,n,h;n=this.organizer.unsyncedCommands;
h=[];c=0;for(g=n.length;c<g;c++)a=n[c],h.push(a);c=reqwest;g=""+this.syncUrl;n=this.client.id;var k=this.externalClients,s,u,v;v=[];s=0;for(u=h.length;s<u;s++)a=h[s],v.push(a.toHash());return c({url:g,type:"json",method:"post",data:{clientId:n,clients:k,commands:v},error:function(){return console.log("push error")},success:function(){return b.organizer.markAsSynced(h)}})};h.prototype.pull=function(){var a=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{clientId:this.client.id,
clients:this.externalClients},error:function(){return console.log("pull error")},success:function(f){a.externalClients=f.data.currentClients;a.stableTimestamp=f.data.stableTimestamp;var c,g,h,x;h=f.data.commands;x=[];c=0;for(g=h.length;c<g;c++)f=h[c],x.push(new b(f.name,f.data,f.connection,new Date(f.timestamp)));a.organizer.addCommands(x,!1);return a.stabilizer.stabilize(a.stableTimestamp)}})};a=h}return a};window.modules=b})();
(function(){var b=window.modules||[],a=null,k=function(){var a=function(){function a(d){y=d}function b(d,a){this.o=d;this.fn=a;f.apply(this,arguments)}function f(d,b){function e(a){d.timeout&&clearTimeout(q.timeout);for(q.timeout=null;0<q._completeHandlers.length;)q._completeHandlers.shift()(a)}function f(d,a,b){q._responseArgs.resp=d;q._responseArgs.msg=a;q._responseArgs.t=b;for(q._erred=!0;0<q._errorHandlers.length;)q._errorHandlers.shift()(d,a,b);e(d)}this.url="string"==typeof d?d:d.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var q=this,g;if(!(g=d.type))g=(g=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?g[1]:"js";var k=g;b=b||function(){};d.timeout&&(this.timeout=setTimeout(function(){q.abort()},d.timeout));d.success&&this._fulfillmentHandlers.push(function(){d.success.apply(d,arguments)});d.error&&this._errorHandlers.push(function(){d.error.apply(d,arguments)});d.complete&&this._completeHandlers.push(function(){d.complete.apply(d,
arguments)});var r;var n=function(d){var a=D.dataFilter(d.responseText,k);if(a=d.responseText=a)switch(k){case "json":try{d=v.JSON?v.JSON.parse(a):eval("("+a+")")}catch(c){return f(d,"Could not parse JSON in response",c)}break;case "js":d=eval(a);break;case "html":d=a;break;case "xml":d=d.responseXML&&d.responseXML.parseError&&d.responseXML.parseError.errorCode&&d.responseXML.parseError.reason?null:d.responseXML}q._responseArgs.resp=d;q._fulfilled=!0;for(b(d);0<q._fulfillmentHandlers.length;)q._fulfillmentHandlers.shift()(d);
e(d)},j=this.o,p=(j.method||"GET").toUpperCase(),m="string"===typeof j?j:j.url;g=!1!==j.processData&&j.data&&"string"!==typeof j.data?c.toQueryString(j.data):j.data||null;var t;if(("jsonp"==j.type||"GET"==p)&&g)m=m+(/\?/.test(m)?"&":"?")+g,g=null;if("jsonp"==j.type){r=m;g=J++;t=j.jsonpCallback||"callback";var p=j.jsonpCallbackName||c.getcallbackPrefix(g),m=RegExp("((^|\\?|&)"+t+")=([^&]+)"),s=r.match(m),l=E.createElement("script"),u=0,x=-1!==navigator.userAgent.indexOf("MSIE 10.0");s?"?"===s[3]?r=
r.replace(m,"$1="+p):p=s[3]:r=r+(/\?/.test(r)?"&":"?")+(t+"="+p);v[p]=a;l.type="text/javascript";l.src=r;l.async=!0;"undefined"!==typeof l.onreadystatechange&&!x&&(l.event="onclick",l.htmlFor=l.id="_reqwest_"+g);l.onload=l.onreadystatechange=function(){if(l[z]&&"complete"!==l[z]&&"loaded"!==l[z]||u)return!1;l.onload=l.onreadystatechange=null;l.onclick&&l.onclick();j.success&&j.success(y);y=void 0;B.removeChild(l);u=1};B.appendChild(l);r={abort:function(){l.onload=l.onreadystatechange=null;j.error&&
j.error({},"Request is aborted: timeout",{});y=void 0;B.removeChild(l);u=1}}}else{t=K();t.open(p,m,!0);p=j.headers||{};p.Accept=p.Accept||A.accept[j.type]||A.accept["*"];!j.crossOrigin&&!p[F]&&(p[F]=A.requestedWith);p[G]||(p[G]=j.contentType||A.contentType);for(r in p)p.hasOwnProperty(r)&&t.setRequestHeader(r,p[r]);"undefined"!==typeof j.withCredentials&&"undefined"!==typeof t.withCredentials&&(t.withCredentials=!!j.withCredentials);var w=this;t.onreadystatechange=function(){if(w._aborted)return f(w.request);
w.request&&4==w.request[z]&&(w.request.onreadystatechange=L,M.test(w.request.status)?n(w.request):f(w.request))};j.before&&j.before(t);t.send(g);r=t}this.request=r}function c(d,a){return new b(d,a)}function g(d){return d?d.replace(/\r?\n/g,"\r\n"):""}function n(d,a){var b=d.name,c=d.tagName.toLowerCase(),e=function(d){d&&!d.disabled&&a(b,g(d.attributes.value&&d.attributes.value.specified?d.value:d.text))},f;if(!d.disabled&&b)switch(c){case "input":/reset|button|image|file/i.test(d.type)||(e=/checkbox/i.test(d.type),
c=/radio/i.test(d.type),f=d.value,(!e&&!c||d.checked)&&a(b,g(e&&""===f?"on":f)));break;case "textarea":a(b,g(d.value));break;case "select":if("select-one"===d.type.toLowerCase())e(0<=d.selectedIndex?d.options[d.selectedIndex]:null);else for(c=0;d.length&&c<d.length;c++)d.options[c].selected&&e(d.options[c])}}function k(){var d,a;for(a=0;a<arguments.length;a++){d=arguments[a];/input|select|textarea/i.test(d.tagName)&&n(d,this);for(var b=["input","select","textarea"],c=void 0,e=void 0,f=void 0,c=0;c<
b.length;c++){f=d[H](b[c]);for(e=0;e<f.length;e++)n(f[e],this)}}}function I(){return c.toQueryString(c.serializeArray.apply(null,arguments))}function s(){var d={};k.apply(function(a,b){a in d?(d[a]&&!C(d[a])&&(d[a]=[d[a]]),d[a].push(b)):d[a]=b},arguments);return d}function u(d,a,b,c){var e,f,g=/\[\]$/;if(C(a))for(e=0;a&&e<a.length;e++)f=a[e],b||g.test(d)?c(d,f):u(d+"["+("object"===typeof f?e:"")+"]",f,b,c);else if("[object Object]"===a.toString())for(e in a)u(d+"["+e+"]",a[e],b,c);else c(d,a)}var v=
window,E=document,M=/^20\d$/,H="getElementsByTagName",z="readyState",G="Content-Type",F="X-Requested-With",B=E[H]("head")[0],J=0,N="reqwest_"+ +new Date,y,L=function(){},C="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},A={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},K=v.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},D={dataFilter:function(a){return a}};b.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){f.call(this,this.o,this.fn)},then:function(a,b){this._fulfilled?a(this._responseArgs.resp):this._erred?b(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(a),this._errorHandlers.push(b));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};c.serializeArray=function(){var a=[];k.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};c.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?s:"array"==a?c.serializeArray:I).apply(null,b)};c.toQueryString=function(a,b){var c,e=b||!1,f=[],g=encodeURIComponent,h=function(a,b){b="function"===typeof b?b():null==b?"":b;f[f.length]=g(a)+"="+g(b)};if(C(a))for(c=0;a&&c<a.length;c++)h(a[c].name,a[c].value);else for(c in a)u(c,a[c],e,h);return f.join("&").replace(/%20/g,"+")};c.getcallbackPrefix=function(){return N};c.compat=function(a,c){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new b(a,c)};c.ajaxSetup=function(a){a=a||{};for(var b in a)D[b]=a[b]};return c};"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):this.reqwest=a();!0};b.lib__reqwest=function(){null===a&&(a=k());return a};window.modules=b})();
(function(){var b=window.modules||[];window.require=function(a){a=a.replace(/\//g,"__");-1===a.indexOf("__")&&(a="__"+a);return null===b[a]?null:b[a]()}})();

