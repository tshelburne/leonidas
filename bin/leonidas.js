(function(){var e=window.modules||[],b=null;e.leonidas__client=function(){null===b&&(b=function(b,h,j,c,a){this.id=b;this.appName=h;this.state=null!=j?j:{};this.appType=null!=c?c:"";null==a&&(a=null);if(null==this.id)throw Error("Client Id is required");if(null==this.appName)throw Error("App Name is required");this.lastUpdate=null!=a?a:new Date(0)});return b};window.modules=e})();
(function(){var e=window.modules||[],b=null;e.leonidas__commander=function(){if(null===b){var e,h,j,c;e=require("leonidas/commands/command");h=require("leonidas/commands/organizer");j=require("leonidas/commands/processor");c=require("leonidas/commands/synchronizer");var a=function(c,a,g,b){this.client=c;this.organizer=a;this.processor=g;this.synchronizer=b};a.create=function(d,a,g){var b;b=new h;a=new j(a);g=new c(g,d,b,a);return new this(d,b,a,g)};a.prototype.startSync=function(c,a){null==c&&(c=
1E3);null==a&&(a=5E3);this.pushInterval=setInterval(this.synchronizer.push,c);return this.pullInterval=setInterval(this.synchronizer.pull,a)};a.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};a.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};a.prototype.issueCommand=function(c,a){var g;g=new e(c,a,this.client.id);this.organizer.local.addCommand(g);return this.processor.runCommand(g)};b=a}return b};window.modules=
e})();(function(){var e=window.modules||[],b=null;e.leonidas__commands__command=function(){if(null===b){var e=function(b,j,c,a,d){this.name=b;this.data=j;this.clientId=c;null==a&&(a=null);this.id=null!=d?d:null;this.timestamp=null!=a?a:new Date};e.prototype.toHash=function(){return{id:this.id,name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};b=e}return b};window.modules=e})();
(function(){var e=window.modules||[],b=null;e.leonidas__commands__command_list=function(){if(null===b){var e=[].indexOf||function(c){for(var a=0,d=this.length;a<d;a++)if(a in this&&this[a]===c)return a;return-1},h=function(){this.commands=[]},j;h.prototype.addCommand=function(c){null==c.id&&(c.id=j(this.commands));return this.commands.push(c)};h.prototype.addCommands=function(c){var a,d,f,g;g=[];d=0;for(f=c.length;d<f;d++)a=c[d],g.push(this.addCommand(a));return g};h.prototype.commandsThrough=function(c){var a,
d,f,g,b;g=this.commands;b=[];d=0;for(f=g.length;d<f;d++)a=g[d],a.timestamp<=c&&b.push(a);return b};h.prototype.commandsSince=function(c){var a,d,f,b,h;b=this.commands;h=[];d=0;for(f=b.length;d<f;d++)a=b[d],a.timestamp>c&&h.push(a);return h};j=function(c){a;for(var a,d;0<=e.call(function(){var a,b,h;h=[];a=0;for(b=c.length;a<b;a++)d=c[a],h.push(d.id);return h}(),a);)a=""+(new Date).getTime()+"-"+c.length;return a};b=h}return b};window.modules=e})();
(function(){var e=window.modules||[],b=null;e.leonidas__commands__handler=function(){if(null===b){var e=function(){};e.prototype.handles=function(b){return b.name===this.name};e.prototype.run=function(){throw Error("Every CommandHandler should override #run.");};e.prototype.rollback=function(){throw Error("Every CommandHandler should override #rollback.");};b=e}return b};window.modules=e})();
(function(){var e=window.modules||[],b=null;e.leonidas__commands__organizer=function(){if(null===b){var e;e=require("leonidas/commands/command_list");var h=function(){this.local=new e;this.external=new e};h.prototype.commandsThrough=function(b){var c,a,d,f,g;f=this.allCommands();g=[];a=0;for(d=f.length;a<d;a++)c=f[a],c.timestamp<=b&&g.push(c);return g};h.prototype.commandsSince=function(b){var c,a,d,f,g;f=this.allCommands();g=[];a=0;for(d=f.length;a<d;a++)c=f[a],c.timestamp>b&&g.push(c);return g};
h.prototype.allCommands=function(){var b,c,a,d,f;d=this.local.commands;f=[];c=0;for(a=d.length;c<a;c++)b=d[c],f.push(b);d=this.external.commands;c=0;for(a=d.length;c<a;c++)b=d[c],f.push(b);return f};h.prototype.commandsFor=function(b,c){var a,d,f,g,h;null==c&&(c=null);null==c&&(c=new Date(0));g=this.commandsSince(c);h=[];d=0;for(f=g.length;d<f;d++)a=g[d],a.clientId===b&&h.push(a);return h};b=h}return b};window.modules=e})();
(function(){var e=window.modules||[],b=null;e.leonidas__commands__processor=function(){if(null===b){var e=function(b){this.handlers=b};e.prototype.runCommand=function(b){var e,c,a,d,f;d=this.handlers;f=[];c=0;for(a=d.length;c<a;c++)e=d[c],e.handles(b)?f.push(e.run(b)):f.push(void 0);return f};e.prototype.runCommands=function(b){var e,c,a,d;b.sort(function(c,a){return c.timestamp>a.timestamp?1:-1});d=[];c=0;for(a=b.length;c<a;c++)e=b[c],d.push(this.runCommand(e));return d};e.prototype.rollbackCommand=
function(b){var e,c,a,d,f;d=this.handlers;f=[];c=0;for(a=d.length;c<a;c++)e=d[c],e.handles(b)?f.push(e.rollback(b)):f.push(void 0);return f};e.prototype.rollbackCommands=function(b){var e,c,a,d;b.sort(function(c,a){return c.timestamp<a.timestamp?1:-1});d=[];c=0;for(a=b.length;c<a;c++)e=b[c],d.push(this.rollbackCommand(e));return d};b=e}return b};window.modules=e})();
(function(){var e=window.modules||[],b=null;e.leonidas__commands__synchronizer=function(){if(null===b){var e,h=function(c,a){return function(){return c.apply(a,arguments)}};require("lib/reqwest");e=require("leonidas/commands/command");var j=function(c,a,d,b){this.syncUrl=c;this.client=a;this.organizer=d;this.processor=b;this.reconcile=h(this.reconcile,this);this.pull=h(this.pull,this);this.push=h(this.push,this);this.stableTimestamp=new Date(0);this.externalClients=[]};j.prototype.push=function(){var c,
a=this,b,e,g,h;g=this.organizer.local.commandsSince(this.client.lastUpdate);h=[];b=0;for(e=g.length;b<e;b++)c=g[b],h.push(c);if(0!==h.length){b=reqwest;e=""+this.syncUrl;g=this.client.appName;var j=this.client.id,m=this.externalClients,q,r,u;u=[];q=0;for(r=h.length;q<r;q++)c=h[q],u.push(c.toHash());return b({url:e,type:"json",method:"post",data:{appName:g,clientId:j,clients:m,commands:u},error:function(){return console.log("push error")},success:function(b){if(b.success)return b=Math.max.apply(a,
function(){var a,b,d;d=[];a=0;for(b=h.length;a<b;a++)c=h[a],d.push(c.timestamp);return d}()),a.client.lastUpdate=new Date(b);if("reconcile required"===b.message&&null==a.reconcileTimeout)return a.reconcileTimeout=setTimeout(a.reconcile,1E3)}})}};j.prototype.pull=function(){var c=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{appName:this.client.appName,clientId:this.client.id,clients:this.externalClients},error:function(){return console.log("pull error")},success:function(a){var b;
if(a.success){var f,g,h,j;h=a.data.commands;j=[];f=0;for(g=h.length;f<g;f++)b=h[f],j.push(new e(b.name,b.data,b.connection,new Date(b.timestamp),b.id));c.processor.rollbackCommands(c.organizer.commandsSince(c.stableTimestamp));c.organizer.external.addCommands(j);c.processor.runCommands(c.organizer.commandsSince(c.stableTimestamp));c.externalClients=a.data.currentClients;return c.stableTimestamp=a.data.stableTimestamp}if("reconcile required"===a.message&&null==c.reconcileTimeout)return c.reconcileTimeout=
setTimeout(c.reconcile,1E3)}})};j.prototype.reconcile=function(){var b,a,d,e,h,j,t=this;a={};d=this.client.id;var m;j=this.organizer.local.commands;m=[];e=0;for(h=j.length;e<h;e++)b=j[e],m.push(b.toHash());a[d]=m;j=this.externalClients;e=0;for(h=j.length;e<h;e++){b=j[e];d=this.organizer.commandsFor(b.id);m=a;for(var q=""+b.id,r=void 0,u=void 0,x=void 0,x=[],r=0,u=d.length;r<u;r++)b=d[r],x.push(b.toHash());m[q]=x}return reqwest({url:""+this.syncUrl+"/reconcile",type:"json",method:"post",data:{appName:this.client.appName,
clientId:this.client.id,clients:this.externalClients,commandList:a,stableTimestamp:this.stableTimestamp},error:function(){return console.log("reconcile error")},success:function(b){if(b.success)return clearInterval(t.reconcileTimeout),t.reconcileTimeout=null;if("reconcile required"===b.message)return t.reconcileTimeout=setTimeout(t.reconcile,1E3)}})};b=j}return b};window.modules=e})();
(function(){var e=window.modules||[],b=null,C=function(){var b=function(){function b(a){A=a}function c(b,c){this.o=b;this.fn=c;a.apply(this,arguments)}function a(a,c){function e(b){a.timeout&&clearTimeout(f.timeout);for(f.timeout=null;0<f._completeHandlers.length;)f._completeHandlers.shift()(b)}function h(a,b,c){f._responseArgs.resp=a;f._responseArgs.msg=b;f._responseArgs.t=c;for(f._erred=!0;0<f._errorHandlers.length;)f._errorHandlers.shift()(a,b,c);e(a)}this.url="string"==typeof a?a:a.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var f=this,g;if(!(g=a.type))g=(g=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?g[1]:"js";var G=g;c=c||function(){};a.timeout&&(this.timeout=setTimeout(function(){f.abort()},a.timeout));a.success&&this._fulfillmentHandlers.push(function(){a.success.apply(a,arguments)});a.error&&this._errorHandlers.push(function(){a.error.apply(a,arguments)});a.complete&&this._completeHandlers.push(function(){a.complete.apply(a,
arguments)});var p;var q=function(a){var b=H.dataFilter(a.responseText,G);if(b=a.responseText=b)switch(G){case "json":try{a=r.JSON?r.JSON.parse(b):eval("("+b+")")}catch(J){return h(a,"Could not parse JSON in response",J)}break;case "js":a=eval(b);break;case "html":a=b;break;case "xml":a=a.responseXML&&a.responseXML.parseError&&a.responseXML.parseError.errorCode&&a.responseXML.parseError.reason?null:a.responseXML}f._responseArgs.resp=a;f._fulfilled=!0;for(c(a);0<f._fulfillmentHandlers.length;)f._fulfillmentHandlers.shift()(a);
e(a)},k=this.o,n=(k.method||"GET").toUpperCase(),m="string"===typeof k?k:k.url;g=!1!==k.processData&&k.data&&"string"!==typeof k.data?d.toQueryString(k.data):k.data||null;var s;if(("jsonp"==k.type||"GET"==n)&&g)m=m+(/\?/.test(m)?"&":"?")+g,g=null;if("jsonp"==k.type){p=m;g=C++;s=k.jsonpCallback||"callback";var n=k.jsonpCallbackName||d.getcallbackPrefix(g),m=RegExp("((^|\\?|&)"+s+")=([^&]+)"),t=p.match(m),l=u.createElement("script"),w=0,y=-1!==navigator.userAgent.indexOf("MSIE 10.0");t?"?"===t[3]?p=
p.replace(m,"$1="+n):n=t[3]:p=p+(/\?/.test(p)?"&":"?")+(s+"="+n);r[n]=b;l.type="text/javascript";l.src=p;l.async=!0;"undefined"!==typeof l.onreadystatechange&&!y&&(l.event="onclick",l.htmlFor=l.id="_reqwest_"+g);l.onload=l.onreadystatechange=function(){if(l[z]&&"complete"!==l[z]&&"loaded"!==l[z]||w)return!1;l.onload=l.onreadystatechange=null;l.onclick&&l.onclick();k.success&&k.success(A);A=void 0;D.removeChild(l);w=1};D.appendChild(l);p={abort:function(){l.onload=l.onreadystatechange=null;k.error&&
k.error({},"Request is aborted: timeout",{});A=void 0;D.removeChild(l);w=1}}}else{s=K();s.open(n,m,!0);n=k.headers||{};n.Accept=n.Accept||B.accept[k.type]||B.accept["*"];!k.crossOrigin&&!n[I]&&(n[I]=B.requestedWith);n[F]||(n[F]=k.contentType||B.contentType);for(p in n)n.hasOwnProperty(p)&&s.setRequestHeader(p,n[p]);"undefined"!==typeof k.withCredentials&&"undefined"!==typeof s.withCredentials&&(s.withCredentials=!!k.withCredentials);var v=this;s.onreadystatechange=function(){if(v._aborted)return h(v.request);
v.request&&4==v.request[z]&&(v.request.onreadystatechange=L,x.test(v.request.status)?q(v.request):h(v.request))};k.before&&k.before(s);s.send(g);p=s}this.request=p}function d(a,b){return new c(a,b)}function e(a){return a?a.replace(/\r?\n/g,"\r\n"):""}function h(a,b){var c=a.name,d=a.tagName.toLowerCase(),g=function(a){a&&!a.disabled&&b(c,e(a.attributes.value&&a.attributes.value.specified?a.value:a.text))},j;if(!a.disabled&&c)switch(d){case "input":/reset|button|image|file/i.test(a.type)||(g=/checkbox/i.test(a.type),
d=/radio/i.test(a.type),j=a.value,(!g&&!d||a.checked)&&b(c,e(g&&""===j?"on":j)));break;case "textarea":b(c,e(a.value));break;case "select":if("select-one"===a.type.toLowerCase())g(0<=a.selectedIndex?a.options[a.selectedIndex]:null);else for(d=0;a.length&&d<a.length;d++)a.options[d].selected&&g(a.options[d])}}function y(){var a,b;for(b=0;b<arguments.length;b++){a=arguments[b];/input|select|textarea/i.test(a.tagName)&&h(a,this);for(var c=["input","select","textarea"],d=void 0,e=void 0,f=void 0,d=0;d<
c.length;d++){f=a[E](c[d]);for(e=0;e<f.length;e++)h(f[e],this)}}}function t(){return d.toQueryString(d.serializeArray.apply(null,arguments))}function m(){var a={};y.apply(function(b,c){b in a?(a[b]&&!w(a[b])&&(a[b]=[a[b]]),a[b].push(c)):a[b]=c},arguments);return a}function q(a,b,c,d){var e,f,g=/\[\]$/;if(w(b))for(e=0;b&&e<b.length;e++)f=b[e],c||g.test(a)?d(a,f):q(a+"["+("object"===typeof f?e:"")+"]",f,c,d);else if("[object Object]"===b.toString())for(e in b)q(a+"["+e+"]",b[e],c,d);else d(a,b)}var r=
window,u=document,x=/^20\d$/,E="getElementsByTagName",z="readyState",F="Content-Type",I="X-Requested-With",D=u[E]("head")[0],C=0,M="reqwest_"+ +new Date,A,L=function(){},w="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},B={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},K=r.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},H={dataFilter:function(a){return a}};c.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){a.call(this,this.o,this.fn)},then:function(a,b){this._fulfilled?a(this._responseArgs.resp):this._erred?b(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(a),this._errorHandlers.push(b));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};d.serializeArray=function(){var a=[];y.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};d.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?m:"array"==a?d.serializeArray:t).apply(null,b)};d.toQueryString=function(a,b){var c,e=b||!1,d=[],f=encodeURIComponent,g=function(a,b){b="function"===typeof b?b():null==b?"":b;d[d.length]=f(a)+"="+f(b)};if(w(a))for(c=0;a&&c<a.length;c++)g(a[c].name,a[c].value);else for(c in a)q(c,a[c],e,g);return d.join("&").replace(/%20/g,"+")};d.getcallbackPrefix=function(){return M};d.compat=function(a,b){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new c(a,b)};d.ajaxSetup=function(a){a=a||{};for(var b in a)H[b]=a[b]};return d};"undefined"!=typeof module&&module.exports?module.exports=b():"function"==typeof define&&define.amd?define(b):this.reqwest=b();!0};e.lib__reqwest=function(){null===b&&(b=C());return b};window.modules=e})();
(function(){var e=window.modules||[];window.require=function(b){b=b.replace(/\//g,"__");-1===b.indexOf("__")&&(b="__"+b);return null===e[b]?null:e[b]()}})();

