(function(){var d=window.modules||[],a=null;d.leonidas__client=function(){if(null===a){var b=function(a,h){this.id=a;this.lockedState=h;this.activeState={};this.copyState(this.activeState,this.lockedState)};b.prototype.revertState=function(){return this.copyState(this.activeState,this.lockedState)};b.prototype.lockState=function(){return this.copyState(this.lockedState,this.activeState)};b.prototype.copyState=function(a,h){var e,g,c;for(e in a)delete a[e];c=[];for(e in h)g=h[e],c.push(a[e]=g);return c};
a=b}return a};window.modules=d})();
(function(){var d=window.modules||[],a=null;d.leonidas__commander=function(){if(null===a){var b,u,h,e,g;b=require("leonidas/commands/command");u=require("leonidas/commands/organizer");h=require("leonidas/commands/processor");e=require("leonidas/commands/stabilizer");g=require("leonidas/commands/synchronizer");var c=function(e,c,g,a,h){this.client=e;this.organizer=c;this.processor=g;this.stabilizer=a;this.synchronizer=h};c.create=function(c,a,b){var d,m;d=new u;a=new h(a);m=new e(c,d,a);b=new g(b,
c,d,m);return new this(c,d,a,m,b)};c.prototype.startSync=function(e,c){null==e&&(e=1E3);null==c&&(c=5E3);this.pushInterval=setInterval(this.synchronizer.push,e);return this.pullInterval=setInterval(this.synchronizer.pull,c)};c.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};c.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};c.prototype.issueCommand=function(e,c){var g;g=new b(e,c,this.client.id);this.organizer.addCommand(g);
return this.processor.runCommand(g)};a=c}return a};window.modules=d})();(function(){var d=window.modules||[],a=null;d.leonidas__commands__command=function(){if(null===a){var b=function(a,h,e,g){this.name=a;this.data=h;this.clientId=e;null==g&&(g=null);this.timestamp=null!=g?g:new Date};b.prototype.toHash=function(){return{name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};a=b}return a};window.modules=d})();
(function(){var d=window.modules||[],a=null;d.leonidas__commands__handler=function(){if(null===a){var b=function(){};b.prototype.handles=function(a){return a.name===this.name};b.prototype.run=function(){throw Error("Every CommandHandler should override #run.");};b.prototype.rollback=function(){throw Error("Every CommandHandler should override #rollback.");};a=b}return a};window.modules=d})();
(function(){var d=window.modules||[],a=null;d.leonidas__commands__organizer=function(){if(null===a){var b=function(){this.localCommands=[];this.externalCommands=[]},d;b.prototype.addCommand=function(a,e){null==e&&(e=!0);return e?(a.id=this.localCommands.length,this.localCommands.push(a)):this.externalCommands.push(a)};b.prototype.addCommands=function(a,e){var g,c,v,b;null==e&&(e=!0);b=[];c=0;for(v=a.length;c<v;c++)g=a[c],b.push(this.addCommand(g,e));return b};b.prototype.commandsUntil=function(a,
e){var g,c,b,r,k;null==e&&(e=!0);c=e?d(this.localCommands):this.allCommands();k=[];b=0;for(r=c.length;b<r;b++)g=c[b],g.timestamp<=a&&k.push(g);return k};b.prototype.commandsAfter=function(a,e){var g,c,b,r,k;null==e&&(e=!0);c=e?d(this.localCommands):this.allCommands();k=[];b=0;for(r=c.length;b<r;b++)g=c[b],g.timestamp>a&&k.push(g);return k};b.prototype.allCommands=function(){return d(this.localCommands.concat(this.externalCommands))};d=function(a){return a.sort(function(e,a){return e.timestamp>a.timestamp?
1:-1})};a=b}return a};window.modules=d})();
(function(){var d=window.modules||[],a=null;d.leonidas__commands__processor=function(){if(null===a){var b=function(a){this.handlers=a};b.prototype.runCommand=function(a){var b,e,g,c,d;c=this.handlers;d=[];e=0;for(g=c.length;e<g;e++)b=c[e],b.handles(a)?d.push(b.run(a)):d.push(void 0);return d};b.prototype.runCommands=function(a){var b,e,g,c;c=[];e=0;for(g=a.length;e<g;e++)b=a[e],c.push(this.runCommand(b));return c};b.prototype.rollbackCommand=function(a){var b,e,g,c,d;c=this.handlers;d=[];e=0;for(g=
c.length;e<g;e++)b=c[e],b.handles(a)?d.push(b.rollback(a)):d.push(void 0);return d};b.prototype.rollbackCommands=function(a){var b,e,g,c;c=[];e=0;for(g=a.length;e<g;e++)b=a[e],c.push(this.rollbackCommand(b));return c};a=b}return a};window.modules=d})();
(function(){var d=window.modules||[],a=null;d.leonidas__commands__stabilizer=function(){if(null===a){var b=function(a,b,e){this.client=a;this.organizer=b;this.processor=e};b.prototype.stabilize=function(a){var b,e,g,c,d;c=this.organizer.activeCommands();d=[];e=0;for(g=c.length;e<g;e++)b=c[e],b.timestamp<=a&&d.push(b);this.client.revertState();this.processor.runCommands(d);this.client.lockState();this.organizer.lockCommands(d);return this.processor.runCommands(this.organizer.activeCommands())};a=b}return a};
window.modules=d})();
(function(){var d=window.modules||[],a=null;d.leonidas__commands__synchronizer=function(){if(null===a){var b,d=function(a,b){return function(){return a.apply(b,arguments)}};require("lib/reqwest");b=require("leonidas/commands/command");var h=function(a,b,c,h){this.syncUrl=a;this.client=b;this.organizer=c;this.stabilizer=h;this.pull=d(this.pull,this);this.push=d(this.push,this);this.stableTimestamp=0;this.externalClients=[];this.syncedTimestamp=0};h.prototype.push=function(){var a,b=this,c,d,h,k;h=
this.organizer.commandsAfter(this.syncedTimestamp);k=[];c=0;for(d=h.length;c<d;c++)a=h[c],k.push(a);c=reqwest;d=""+this.syncUrl;h=this.client.id;var u=this.externalClients,m,w,x;x=[];m=0;for(w=k.length;m<w;m++)a=k[m],x.push(a.toHash());return c({url:d,type:"json",method:"post",data:{clientId:h,clients:u,commands:x},error:function(){return console.log("push error")},success:function(){return b.syncedTimestamp=k[k.length-1].timestamp}})};h.prototype.pull=function(){var a=this;return reqwest({url:""+
this.syncUrl,type:"json",method:"get",data:{clientId:this.client.id,clients:this.externalClients},error:function(){return console.log("pull error")},success:function(d){a.externalClients=d.data.currentClients;a.stableTimestamp=d.data.stableTimestamp;var c,h,r,k;r=d.data.commands;k=[];c=0;for(h=r.length;c<h;c++)d=r[c],k.push(new b(d.name,d.data,d.connection,new Date(d.timestamp)));a.organizer.addCommands(k,!1);return a.stabilizer.stabilize(a.stableTimestamp)}})};a=h}return a};window.modules=d})();
(function(){var d=window.modules||[],a=null,b=function(){var a=function(){function a(f){z=f}function b(f,a){this.o=f;this.fn=a;d.apply(this,arguments)}function d(f,b){function e(a){f.timeout&&clearTimeout(p.timeout);for(p.timeout=null;0<p._completeHandlers.length;)p._completeHandlers.shift()(a)}function g(f,a,b){p._responseArgs.resp=f;p._responseArgs.msg=a;p._responseArgs.t=b;for(p._erred=!0;0<p._errorHandlers.length;)p._errorHandlers.shift()(f,a,b);e(f)}this.url="string"==typeof f?f:f.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var p=this,s;if(!(s=f.type))s=(s=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?s[1]:"js";var k=s;b=b||function(){};f.timeout&&(this.timeout=setTimeout(function(){p.abort()},f.timeout));f.success&&this._fulfillmentHandlers.push(function(){f.success.apply(f,arguments)});f.error&&this._errorHandlers.push(function(){f.error.apply(f,arguments)});f.complete&&this._completeHandlers.push(function(){f.complete.apply(f,
arguments)});var q;var r=function(f){var a=E.dataFilter(f.responseText,k);if(a=f.responseText=a)switch(k){case "json":try{f=x.JSON?x.JSON.parse(a):eval("("+a+")")}catch(c){return g(f,"Could not parse JSON in response",c)}break;case "js":f=eval(a);break;case "html":f=a;break;case "xml":f=f.responseXML&&f.responseXML.parseError&&f.responseXML.parseError.errorCode&&f.responseXML.parseError.reason?null:f.responseXML}p._responseArgs.resp=f;p._fulfilled=!0;for(b(f);0<p._fulfillmentHandlers.length;)p._fulfillmentHandlers.shift()(f);
e(f)},j=this.o,n=(j.method||"GET").toUpperCase(),m="string"===typeof j?j:j.url;s=!1!==j.processData&&j.data&&"string"!==typeof j.data?c.toQueryString(j.data):j.data||null;var t;if(("jsonp"==j.type||"GET"==n)&&s)m=m+(/\?/.test(m)?"&":"?")+s,s=null;if("jsonp"==j.type){q=m;s=J++;t=j.jsonpCallback||"callback";var n=j.jsonpCallbackName||c.getcallbackPrefix(s),m=RegExp("((^|\\?|&)"+t+")=([^&]+)"),u=q.match(m),l=F.createElement("script"),v=0,w=-1!==navigator.userAgent.indexOf("MSIE 10.0");u?"?"===u[3]?q=
q.replace(m,"$1="+n):n=u[3]:q=q+(/\?/.test(q)?"&":"?")+(t+"="+n);x[n]=a;l.type="text/javascript";l.src=q;l.async=!0;"undefined"!==typeof l.onreadystatechange&&!w&&(l.event="onclick",l.htmlFor=l.id="_reqwest_"+s);l.onload=l.onreadystatechange=function(){if(l[A]&&"complete"!==l[A]&&"loaded"!==l[A]||v)return!1;l.onload=l.onreadystatechange=null;l.onclick&&l.onclick();j.success&&j.success(z);z=void 0;C.removeChild(l);v=1};C.appendChild(l);q={abort:function(){l.onload=l.onreadystatechange=null;j.error&&
j.error({},"Request is aborted: timeout",{});z=void 0;C.removeChild(l);v=1}}}else{t=K();t.open(n,m,!0);n=j.headers||{};n.Accept=n.Accept||B.accept[j.type]||B.accept["*"];!j.crossOrigin&&!n[G]&&(n[G]=B.requestedWith);n[H]||(n[H]=j.contentType||B.contentType);for(q in n)n.hasOwnProperty(q)&&t.setRequestHeader(q,n[q]);"undefined"!==typeof j.withCredentials&&"undefined"!==typeof t.withCredentials&&(t.withCredentials=!!j.withCredentials);var y=this;t.onreadystatechange=function(){if(y._aborted)return g(y.request);
y.request&&4==y.request[A]&&(y.request.onreadystatechange=L,M.test(y.request.status)?r(y.request):g(y.request))};j.before&&j.before(t);t.send(s);q=t}this.request=q}function c(f,a){return new b(f,a)}function v(f){return f?f.replace(/\r?\n/g,"\r\n"):""}function r(f,a){var b=f.name,c=f.tagName.toLowerCase(),d=function(f){f&&!f.disabled&&a(b,v(f.attributes.value&&f.attributes.value.specified?f.value:f.text))},e;if(!f.disabled&&b)switch(c){case "input":/reset|button|image|file/i.test(f.type)||(d=/checkbox/i.test(f.type),
c=/radio/i.test(f.type),e=f.value,(!d&&!c||f.checked)&&a(b,v(d&&""===e?"on":e)));break;case "textarea":a(b,v(f.value));break;case "select":if("select-one"===f.type.toLowerCase())d(0<=f.selectedIndex?f.options[f.selectedIndex]:null);else for(c=0;f.length&&c<f.length;c++)f.options[c].selected&&d(f.options[c])}}function k(){var f,a;for(a=0;a<arguments.length;a++){f=arguments[a];/input|select|textarea/i.test(f.tagName)&&r(f,this);for(var b=["input","select","textarea"],c=void 0,d=void 0,e=void 0,c=0;c<
b.length;c++){e=f[I](b[c]);for(d=0;d<e.length;d++)r(e[d],this)}}}function u(){return c.toQueryString(c.serializeArray.apply(null,arguments))}function m(){var f={};k.apply(function(a,b){a in f?(f[a]&&!D(f[a])&&(f[a]=[f[a]]),f[a].push(b)):f[a]=b},arguments);return f}function w(a,b,c,d){var e,g,h=/\[\]$/;if(D(b))for(e=0;b&&e<b.length;e++)g=b[e],c||h.test(a)?d(a,g):w(a+"["+("object"===typeof g?e:"")+"]",g,c,d);else if("[object Object]"===b.toString())for(e in b)w(a+"["+e+"]",b[e],c,d);else d(a,b)}var x=
window,F=document,M=/^20\d$/,I="getElementsByTagName",A="readyState",H="Content-Type",G="X-Requested-With",C=F[I]("head")[0],J=0,N="reqwest_"+ +new Date,z,L=function(){},D="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},B={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},K=x.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},E={dataFilter:function(a){return a}};b.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){d.call(this,this.o,this.fn)},then:function(a,b){this._fulfilled?a(this._responseArgs.resp):this._erred?b(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(a),this._errorHandlers.push(b));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};c.serializeArray=function(){var a=[];k.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};c.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?m:"array"==a?c.serializeArray:u).apply(null,b)};c.toQueryString=function(a,b){var c,d=b||!1,e=[],g=encodeURIComponent,h=function(a,b){b="function"===typeof b?b():null==b?"":b;e[e.length]=g(a)+"="+g(b)};if(D(a))for(c=0;a&&c<a.length;c++)h(a[c].name,a[c].value);else for(c in a)w(c,a[c],d,h);return e.join("&").replace(/%20/g,"+")};c.getcallbackPrefix=function(){return N};c.compat=function(a,c){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new b(a,c)};c.ajaxSetup=function(a){a=a||{};for(var b in a)E[b]=a[b]};return c};"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):this.reqwest=a();!0};d.lib__reqwest=function(){null===a&&(a=b());return a};window.modules=d})();
(function(){var d=window.modules||[];window.require=function(a){a=a.replace(/\//g,"__");-1===a.indexOf("__")&&(a="__"+a);return null===d[a]?null:d[a]()}})();

