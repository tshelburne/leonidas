(function(){var c=window.modules||[],a=null;c.leonidas__client=function(){if(null===a){var h=function(g,j){this.id=g;this.lockedState=j;this.activeState={};this.copyState(this.activeState,this.lockedState)};h.prototype.revertState=function(){return this.copyState(this.activeState,this.lockedState)};h.prototype.lockState=function(){return this.copyState(this.lockedState,this.activeState)};h.prototype.copyState=function(g,j){var b,f,d;for(b in g)delete g[b];d=[];for(b in j)f=j[b],d.push(g[b]=f);return d};
a=h}return a};window.modules=c})();
(function(){var c=window.modules||[],a=null;c.leonidas__commander=function(){if(null===a){var h,g,j,b,f;h=require("leonidas/commands/command");g=require("leonidas/commands/organizer");j=require("leonidas/commands/processor");b=require("leonidas/commands/stabilizer");f=require("leonidas/commands/synchronizer");var d=function(b,d,f,j,g){this.client=b;this.organizer=d;this.processor=f;this.stabilizer=j;this.synchronizer=g};d.create=function(d,a,h){var c,q;c=new g;a=new j(a);q=new b(d,c,a);h=new f(h,
d,c,q);return new this(d,c,a,q,h)};d.prototype.startSync=function(b,d){null==b&&(b=1E3);null==d&&(d=5E3);this.pushInterval=setInterval(this.synchronizer.push,b);return this.pullInterval=setInterval(this.synchronizer.pull,d)};d.prototype.stopSync=function(){clearInterval(this.pushInterval);return clearInterval(this.pullInterval)};d.prototype.forceSync=function(){this.synchronizer.push();return this.synchronizer.pull()};d.prototype.issueCommand=function(b,d){var f;f=new h(b,d,this.client.id);this.organizer.addCommand(f);
return this.processor.runCommand(f)};a=d}return a};window.modules=c})();(function(){var c=window.modules||[],a=null;c.leonidas__commands__command=function(){if(null===a){var h=function(a,j,b,f){this.name=a;this.data=j;this.clientId=b;null==f&&(f=null);this.timestamp=null!=f?f:new Date};h.prototype.toHash=function(){return{name:this.name,data:this.data,clientId:this.clientId,timestamp:this.timestamp.getTime()}};a=h}return a};window.modules=c})();
(function(){var c=window.modules||[],a=null;c.leonidas__commands__handler=function(){if(null===a){var h=function(){};h.prototype.handles=function(a){return a.name===this.name};h.prototype.run=function(){throw Error("Every CommandHandler should override #run.");};h.prototype.rollback=function(){throw Error("Every CommandHandler should override #rollback.");};a=h}return a};window.modules=c})();
(function(){var c=window.modules||[],a=null;c.leonidas__commands__organizer=function(){if(null===a){var h=[].indexOf||function(j){for(var b=0,f=this.length;b<f;b++)if(b in this&&this[b]===j)return b;return-1},g=function(){this.unsyncedCommands=[];this.syncedCommands=[];this.lockedCommands=[]};g.prototype.addCommand=function(j,b){null==b&&(b=!0);return b?this.unsyncedCommands.push(j):this.syncedCommands.push(j)};g.prototype.addCommands=function(j,b){var f,d,a,g;null==b&&(b=!0);g=[];d=0;for(a=j.length;d<
a;d++)f=j[d],g.push(this.addCommand(f,b));return g};g.prototype.markAsSynced=function(a){var b,f,d;f=0;for(d=a.length;f<d;f++)b=a[f],0>h.call(this.syncedCommands,b)&&this.syncedCommands.push(b);var g,c;g=this.unsyncedCommands;c=[];f=0;for(d=g.length;f<d;f++)b=g[f],0>h.call(a,b)&&c.push(b);return this.unsyncedCommands=c};g.prototype.lockCommands=function(a){var b,f,d;f=0;for(d=a.length;f<d;f++)b=a[f],this.lockedCommands.push(b);var g,c;g=this.syncedCommands;c=[];f=0;for(d=g.length;f<d;f++)b=g[f],0>
h.call(a,b)&&c.push(b);return this.syncedCommands=c};g.prototype.activeCommands=function(){return this.unsyncedCommands.concat(this.syncedCommands).sort(function(a,b){return a.timestamp>b.timestamp?1:-1})};a=g}return a};window.modules=c})();
(function(){var c=window.modules||[],a=null;c.leonidas__commands__processor=function(){if(null===a){var c=function(a){this.handlers=a};c.prototype.runCommand=function(a){var c,b,f,d,h;d=this.handlers;h=[];b=0;for(f=d.length;b<f;b++)c=d[b],c.handles(a)?h.push(c.run(a)):h.push(void 0);return h};c.prototype.runCommands=function(a){var c,b,f,d;d=[];b=0;for(f=a.length;b<f;b++)c=a[b],d.push(this.runCommand(c));return d};c.prototype.rollbackCommand=function(a){var c,b,f,d,h;d=this.handlers;h=[];b=0;for(f=
d.length;b<f;b++)c=d[b],c.handles(a)?h.push(c.rollback(a)):h.push(void 0);return h};c.prototype.rollbackCommands=function(a){var c,b,f,d;d=[];b=0;for(f=a.length;b<f;b++)c=a[b],d.push(this.rollbackCommand(c));return d};a=c}return a};window.modules=c})();
(function(){var c=window.modules||[],a=null;c.leonidas__commands__stabilizer=function(){if(null===a){var c=function(a,c,b){this.client=a;this.organizer=c;this.processor=b};c.prototype.stabilize=function(a){var c,b,f,d,h;d=this.organizer.activeCommands();h=[];b=0;for(f=d.length;b<f;b++)c=d[b],c.timestamp<=a&&h.push(c);this.client.revertState();this.processor.runCommands(h);this.client.lockState();this.organizer.lockCommands(h);return this.processor.runCommands(this.organizer.activeCommands())};a=c}return a};
window.modules=c})();
(function(){var c=window.modules||[],a=null;c.leonidas__commands__synchronizer=function(){if(null===a){var c,g=function(b,a){return function(){return b.apply(a,arguments)}};require("lib/reqwest");c=require("leonidas/commands/command");var j=function(b,a,d,c){this.syncUrl=b;this.client=a;this.organizer=d;this.stabilizer=c;this.pull=g(this.pull,this);this.push=g(this.push,this);this.stableTimestamp=0;this.externalClients=[]};j.prototype.push=function(){var b,a=this,d,c,h,g;h=this.organizer.unsyncedCommands;g=
[];d=0;for(c=h.length;d<c;d++)b=h[d],g.push(b);d=reqwest;c=""+this.syncUrl;h=this.client.id;var j=this.externalClients,q,t,u;u=[];q=0;for(t=g.length;q<t;q++)b=g[q],u.push(b.toHash());return d({url:c,type:"json",method:"post",data:{clientId:h,clients:j,commands:u},error:function(){return console.log("push error")},success:function(){return a.organizer.markAsSynced(g)}})};j.prototype.pull=function(){var b=this;return reqwest({url:""+this.syncUrl,type:"json",method:"get",data:{clientId:this.client.id,
clients:this.externalClients},error:function(){return console.log("pull error")},success:function(a){b.externalClients=a.data.currentClients;b.stableTimestamp=a.data.stableTimestamp;var d,g,j,s;j=a.data.commands;s=[];d=0;for(g=j.length;d<g;d++)a=j[d],s.push(new c(a.name,a.data,a.connection,new Date(a.timestamp)));b.organizer.addCommands(s,!1);return b.stabilizer.stabilize(b.stableTimestamp)}})};a=j}return a};window.modules=c})();
(function(){var c=window.modules||[],a=null,h=function(){var a=function(){function a(e){y=e}function b(e,a){this.o=e;this.fn=a;c.apply(this,arguments)}function c(e,b){function f(a){e.timeout&&clearTimeout(g.timeout);for(g.timeout=null;0<g._completeHandlers.length;)g._completeHandlers.shift()(a)}function h(e,a,b){g._responseArgs.resp=e;g._responseArgs.msg=a;g._responseArgs.t=b;for(g._erred=!0;0<g._errorHandlers.length;)g._errorHandlers.shift()(e,a,b);f(e)}this.url="string"==typeof e?e:e.url;this.timeout=
null;this._fulfilled=!1;this._fulfillmentHandlers=[];this._errorHandlers=[];this._completeHandlers=[];this._erred=!1;this._responseArgs={};var g=this,p;if(!(p=e.type))p=(p=this.url.match(/\.(json|jsonp|html|xml)(\?|$)/))?p[1]:"js";var C=p;b=b||function(){};e.timeout&&(this.timeout=setTimeout(function(){g.abort()},e.timeout));e.success&&this._fulfillmentHandlers.push(function(){e.success.apply(e,arguments)});e.error&&this._errorHandlers.push(function(){e.error.apply(e,arguments)});e.complete&&this._completeHandlers.push(function(){e.complete.apply(e,
arguments)});var n;var q=function(e){var a=D.dataFilter(e.responseText,C);if(a=e.responseText=a)switch(C){case "json":try{e=u.JSON?u.JSON.parse(a):eval("("+a+")")}catch(c){return h(e,"Could not parse JSON in response",c)}break;case "js":e=eval(a);break;case "html":e=a;break;case "xml":e=e.responseXML&&e.responseXML.parseError&&e.responseXML.parseError.errorCode&&e.responseXML.parseError.reason?null:e.responseXML}g._responseArgs.resp=e;g._fulfilled=!0;for(b(e);0<g._fulfillmentHandlers.length;)g._fulfillmentHandlers.shift()(e);
f(e)},k=this.o,m=(k.method||"GET").toUpperCase(),v="string"===typeof k?k:k.url;p=!1!==k.processData&&k.data&&"string"!==typeof k.data?d.toQueryString(k.data):k.data||null;var r;if(("jsonp"==k.type||"GET"==m)&&p)v=v+(/\?/.test(v)?"&":"?")+p,p=null;if("jsonp"==k.type){n=v;p=J++;r=k.jsonpCallback||"callback";var m=k.jsonpCallbackName||d.getcallbackPrefix(p),v=RegExp("((^|\\?|&)"+r+")=([^&]+)"),s=n.match(v),l=E.createElement("script"),t=0,x=-1!==navigator.userAgent.indexOf("MSIE 10.0");s?"?"===s[3]?n=
n.replace(v,"$1="+m):m=s[3]:n=n+(/\?/.test(n)?"&":"?")+(r+"="+m);u[m]=a;l.type="text/javascript";l.src=n;l.async=!0;"undefined"!==typeof l.onreadystatechange&&!x&&(l.event="onclick",l.htmlFor=l.id="_reqwest_"+p);l.onload=l.onreadystatechange=function(){if(l[z]&&"complete"!==l[z]&&"loaded"!==l[z]||t)return!1;l.onload=l.onreadystatechange=null;l.onclick&&l.onclick();k.success&&k.success(y);y=void 0;B.removeChild(l);t=1};B.appendChild(l);n={abort:function(){l.onload=l.onreadystatechange=null;k.error&&
k.error({},"Request is aborted: timeout",{});y=void 0;B.removeChild(l);t=1}}}else{r=K();r.open(m,v,!0);m=k.headers||{};m.Accept=m.Accept||A.accept[k.type]||A.accept["*"];!k.crossOrigin&&!m[F]&&(m[F]=A.requestedWith);m[G]||(m[G]=k.contentType||A.contentType);for(n in m)m.hasOwnProperty(n)&&r.setRequestHeader(n,m[n]);"undefined"!==typeof k.withCredentials&&"undefined"!==typeof r.withCredentials&&(r.withCredentials=!!k.withCredentials);var w=this;r.onreadystatechange=function(){if(w._aborted)return h(w.request);
w.request&&4==w.request[z]&&(w.request.onreadystatechange=L,M.test(w.request.status)?q(w.request):h(w.request))};k.before&&k.before(r);r.send(p);n=r}this.request=n}function d(e,a){return new b(e,a)}function h(e){return e?e.replace(/\r?\n/g,"\r\n"):""}function g(e,a){var b=e.name,c=e.tagName.toLowerCase(),d=function(e){e&&!e.disabled&&a(b,h(e.attributes.value&&e.attributes.value.specified?e.value:e.text))},f;if(!e.disabled&&b)switch(c){case "input":/reset|button|image|file/i.test(e.type)||(d=/checkbox/i.test(e.type),
c=/radio/i.test(e.type),f=e.value,(!d&&!c||e.checked)&&a(b,h(d&&""===f?"on":f)));break;case "textarea":a(b,h(e.value));break;case "select":if("select-one"===e.type.toLowerCase())d(0<=e.selectedIndex?e.options[e.selectedIndex]:null);else for(c=0;e.length&&c<e.length;c++)e.options[c].selected&&d(e.options[c])}}function s(){var e,a;for(a=0;a<arguments.length;a++){e=arguments[a];/input|select|textarea/i.test(e.tagName)&&g(e,this);for(var b=["input","select","textarea"],c=void 0,d=void 0,f=void 0,c=0;c<
b.length;c++){f=e[H](b[c]);for(d=0;d<f.length;d++)g(f[d],this)}}}function I(){return d.toQueryString(d.serializeArray.apply(null,arguments))}function q(){var e={};s.apply(function(a,b){a in e?(e[a]&&!x(e[a])&&(e[a]=[e[a]]),e[a].push(b)):e[a]=b},arguments);return e}function t(e,a,b,c){var d,f,g=/\[\]$/;if(x(a))for(d=0;a&&d<a.length;d++)f=a[d],b||g.test(e)?c(e,f):t(e+"["+("object"===typeof f?d:"")+"]",f,b,c);else if("[object Object]"===a.toString())for(d in a)t(e+"["+d+"]",a[d],b,c);else c(e,a)}var u=
window,E=document,M=/^20\d$/,H="getElementsByTagName",z="readyState",G="Content-Type",F="X-Requested-With",B=E[H]("head")[0],J=0,N="reqwest_"+ +new Date,y,L=function(){},x="function"==typeof Array.isArray?Array.isArray:function(e){return e instanceof Array},A={contentType:"application/x-www-form-urlencoded",requestedWith:"XMLHttpRequest",accept:{"*":"text/javascript, text/html, application/xml, text/xml, */*",xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript",
js:"application/javascript, text/javascript"}},K=u.XMLHttpRequest?function(){return new XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},D={dataFilter:function(e){return e}};b.prototype={abort:function(){this._aborted=!0;this.request.abort()},retry:function(){c.call(this,this.o,this.fn)},then:function(e,a){this._fulfilled?e(this._responseArgs.resp):this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):(this._fulfillmentHandlers.push(e),this._errorHandlers.push(a));
return this},always:function(a){this._fulfilled||this._erred?a(this._responseArgs.resp):this._completeHandlers.push(a);return this},fail:function(a){this._erred?a(this._responseArgs.resp,this._responseArgs.msg,this._responseArgs.t):this._errorHandlers.push(a);return this}};d.serializeArray=function(){var a=[];s.apply(function(b,c){a.push({name:b,value:c})},arguments);return a};d.serialize=function(){if(0===arguments.length)return"";var a,b=Array.prototype.slice.call(arguments,0);(a=b.pop())&&a.nodeType&&
b.push(a)&&(a=null);a&&(a=a.type);return("map"==a?q:"array"==a?d.serializeArray:I).apply(null,b)};d.toQueryString=function(a,b){var c,d=b||!1,f=[],g=encodeURIComponent,h=function(a,b){b="function"===typeof b?b():null==b?"":b;f[f.length]=g(a)+"="+g(b)};if(x(a))for(c=0;a&&c<a.length;c++)h(a[c].name,a[c].value);else for(c in a)t(c,a[c],d,h);return f.join("&").replace(/%20/g,"+")};d.getcallbackPrefix=function(){return N};d.compat=function(a,c){a&&(a.type&&(a.method=a.type)&&delete a.type,a.dataType&&
(a.type=a.dataType),a.jsonpCallback&&(a.jsonpCallbackName=a.jsonpCallback)&&delete a.jsonpCallback,a.jsonp&&(a.jsonpCallback=a.jsonp));return new b(a,c)};d.ajaxSetup=function(a){a=a||{};for(var b in a)D[b]=a[b]};return d};"undefined"!=typeof module&&module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):this.reqwest=a();!0};c.lib__reqwest=function(){null===a&&(a=h());return a};window.modules=c})();
(function(){var c=window.modules||[];window.require=function(a){a=a.replace(/\//g,"__");-1===a.indexOf("__")&&(a="__"+a);return null===c[a]?null:c[a]()}})();

